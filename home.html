<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub Resili√™ncia Clim√°tica ‚Ä¢ In√≠cio</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green-regen:#1B7F5A;
      --green-light:#4CAF8F;
      --blue-deep:#0D3B66;
      --yellow:#F2C94C;

      --graphite:#2E2E2E;
      --bg:#F5F7F6;
      --white:#FFFFFF;

      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --border:#E7ECEA;
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--graphite);
    }
    h1,h2,h3{ font-family:'Poppins', sans-serif; margin:0; }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea { font-family:inherit; }

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:16px;
      height: calc(100vh - 32px);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(13,59,102,0.98), rgba(27,127,90,0.98));
      box-shadow: var(--shadow);
      color:#fff;
      padding:14px;
      overflow:hidden;
    }

    .sidebar-title{
      padding:10px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.14);
      margin-bottom:12px;
    }
    .sidebar-title strong{ display:block; font-size:15px; letter-spacing:0.2px; }
    .sidebar-title span{ display:block; font-size:12.5px; opacity:.9; margin-top:4px; }

    .profile{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
    }

    .avatar{
      width:56px;
      height:56px;
      border-radius:999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-family:'Poppins';
      letter-spacing:0.4px;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pmeta{ min-width:0; display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .pmeta strong{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pmeta .sub{ font-size:12px; opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .bio{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,0.10);
      border: 1px dashed rgba(255,255,255,0.20);
      font-size:12.5px;
      line-height:1.45;
      opacity:.95;
    }

    .chips{ margin-top:10px; display:grid; gap:8px; }
    .chip{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12.5px;
    }
    .chip strong{ font-family:'Poppins'; font-size:12px; }
    .chip span{
      opacity:.95;
      text-align:right;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 170px;
    }

    .nav{ margin-top:12px; display:grid; gap:6px; }
    .nav a{
      cursor:pointer;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      text-align:left;
      border: 1px solid transparent;
      opacity:.96;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav a:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.12); }
    .nav .active{ background: rgba(242,201,76,0.14); border-color: rgba(242,201,76,0.28); }

    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 3px rgba(242,201,76,0.16);
      flex:0 0 auto;
    }

    .sidebar-bottom{
      position:absolute;
      left:14px;
      right:14px;
      bottom:12px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.14);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      opacity:.9;
    }
    .logoutBtn{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:left;
    }
    .logoutBtn:hover{ background: rgba(255,255,255,0.14); }

    /* Content */
    .content{ display:flex; flex-direction:column; gap:12px; }

    .topbar{
      position:sticky;
      top:16px;
      z-index:5;
      background: rgba(245,247,246,0.82);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar h2{ font-size:16px; }
    .muted{ color:#666; font-size:13px; line-height:1.5; }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
    }
    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size:14px;
    }

    .pillbtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      color:var(--blue-deep);
      cursor:pointer;
      white-space:nowrap;
    }

    /* NEW: Sections layout (3 partes) */
    .mainstack{ display:flex; flex-direction:column; gap:12px; }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .cardHead{
      padding:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
    }
    .cardHead h3{ font-size:14px; }
    .cardBody{ padding:14px; }

    .projectHero{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:12px;
      align-items:stretch;
    }
    .projectBox{
      background: linear-gradient(135deg, rgba(27,127,90,0.12), rgba(13,59,102,0.08));
      border:1px solid rgba(13,59,102,0.10);
      border-radius:18px;
      padding:14px;
      min-height: 180px;
    }
    .projectBox h1{
      font-size:22px;
      letter-spacing:-0.02em;
      line-height:1.15;
      margin-bottom:8px;
    }
    .projectBox p{
      margin:0;
      font-size:13.5px;
      line-height:1.6;
      color:#2e2e2e;
    }
    .pillrow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(13,59,102,0.12);
      color:#0d3b66;
      font-weight:900;
      font-family:'Poppins';
    }

    .demoBox{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background:#fff;
      min-height: 180px;
    }
    .demoList{
      margin-top:10px;
      display:grid;
      gap:8px;
    }
    .demoItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .demoItem b{ font-family:'Poppins'; font-size:12.5px; }
    .demoItem span{ color:#666; font-size:12.5px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background:#fff;
    }
    .kpi .label{ font-size:12px; color:#666; }
    .kpi .value{
      font-family:'Poppins';
      font-size:22px;
      margin-top:6px;
      letter-spacing:-0.02em;
    }
    .kpi .hint{ font-size:12px; color:#666; margin-top:6px; }

    .alerts{
      margin-top:12px;
      border:1px solid rgba(242,201,76,0.35);
      background: rgba(242,201,76,0.16);
      border-radius:18px;
      padding:12px 14px;
      font-size:13px;
      line-height:1.5;
      color:#5b4a12;
    }

    /* Instagram-like feed cards */
    .feed{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .post{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .post-head{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px 10px;
    }
    .post-avatar{
      width:40px;
      height:40px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(76,175,143,0.25), rgba(27,127,90,0.25));
      border:1px solid rgba(27,127,90,0.20);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-family:'Poppins';
      color:#0d3b66;
      flex:0 0 auto;
    }
    .post-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .post-meta{ min-width:0; flex:1; display:flex; flex-direction:column; gap:2px; }
    .post-meta strong{ font-size:13.5px; font-family:'Poppins'; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .post-meta span{ font-size:12px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .post-body{
      padding: 0 12px 12px;
      font-size:14px;
      line-height:1.55;
      color:#2E2E2E;
      white-space:pre-wrap;
    }

    .tags{
      padding: 0 12px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .tag{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:#0d3b66;
      font-weight:800;
    }

    .post-actions{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px 12px;
      border-top:1px solid var(--border);
    }
    .iconbtn{
      border:none;
      cursor:pointer;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .iconbtn:hover{
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
      transform: translateY(-1px);
    }
    .iconbtn:active{ transform: translateY(0); opacity:.92; }

    .commentbox{
      padding: 0 12px 12px;
      display:none;
    }
    .commentbox.show{ display:block; }

    .commentlist{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin: 10px 0 0;
      max-height: 220px;
      overflow:auto;
      padding-right:4px;
    }
    .comment{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .comment strong{ font-family:'Poppins'; font-size:12.5px; }
    .comment span{ display:block; font-size:12.5px; color:#2e2e2e; margin-top:2px; white-space:pre-wrap; }
    .comment small{ display:block; margin-top:6px; font-size:11.5px; color:#777; }

    .empty{
      padding:16px;
      border:1px dashed rgba(13,59,102,0.25);
      border-radius:18px;
      background:#fff;
      color:#4a4a4a;
      font-size:13px;
      line-height:1.5;
    }

    @media (max-width: 1040px){
      .projectHero{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .topbar{ top:12px; }
      .sidebar-bottom{ position:relative; left:0; right:0; bottom:0; margin-top:12px; }
      .kpis{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-title" translate="no">
        <strong>Hub Resili√™ncia Clim√°tica</strong>
        <span>Reciclagem ‚Ä¢ Territ√≥rios ‚Ä¢ Impacto</span>
      </div>

      <div class="profile" aria-label="Perfil do usu√°rio" translate="no">
        <div class="avatar" id="avatarBox">HR</div>
        <div class="pmeta">
          <strong id="userName">Carregando...</strong>
          <div class="sub" id="userRole">Perfil: ‚Äî</div>
          <div class="sub" id="userEmail">‚Äî</div>
        </div>
      </div>

      <div class="bio" id="userBio" translate="no">Carregando mini bio...</div>

      <div class="chips" aria-label="Atribui√ß√µes" translate="no">
        <div class="chip"><strong>CRGR</strong> <span id="userCrgr">‚Äî</span></div>
        <div class="chip"><strong>Organiza√ß√£o</strong> <span id="userOrg">‚Äî</span></div>
      </div>

      <nav class="nav" id="navMenu" aria-label="Menu lateral" translate="no"></nav>

      <div class="sidebar-bottom">
        <button id="logoutBtn" class="logoutBtn" translate="no">
          <span class="dot"></span> Sair
        </button>
        <div translate="no">Plataforma Regenera ‚Ä¢ v0.1</div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar" translate="no">
        <div style="min-width:220px;">
          <h2>In√≠cio</h2>
          <div class="muted" id="subtitle">Hub ‚Ä¢ Vis√£o geral</div>
        </div>

        <div class="search" aria-label="Pesquisar">
          <span style="opacity:.65;">üîé</span>
          <input id="searchInput" placeholder="Pesquisar no feed..." translate="no" />
        </div>

        <button class="pillbtn" id="adminBtn" type="button" style="display:none;" translate="no">Admin</button>
      </div>

      <div class="mainstack">
        <!-- 1) ESPA√áO SOBRE O PROJETO -->
        <section class="card" id="aboutCard" translate="no">
          <div class="cardHead">
            <div>
              <h3>Sobre o projeto</h3>
              <div class="muted">Vis√£o, foco e demonstrativos</div>
            </div>
            <button class="pillbtn" id="learnMoreBtn" type="button">Saiba mais</button>
          </div>
          <div class="cardBody">
            <div class="projectHero">
              <div class="projectBox">
                <h1>Regenerando territ√≥rios atrav√©s da a√ß√£o clim√°tica.</h1>
                <p>
                O <strong>Hub Resili√™ncia Clim√°tica</strong> nasceu a partir de uma constata√ß√£o simples e urgente:
 em situa√ß√µes de crise clim√°tica, o lixo vira um problema antes, durante e depois do desastre.</p>

<p>As enchentes no Rio Grande do Sul deixaram isso evidente. Faltavam informa√ß√£o, coordena√ß√£o, espa√ßos de 
  refer√™ncia e apoio t√©cnico nos territ√≥rios. Ao mesmo tempo, cooperativas, catadores e lideran√ßas comunit√°rias 
  estavam na linha de frente, muitas vezes sem estrutura e reconhecimento.</p>

<p>Foi nesse contexto que o Hub come√ßou a ser constru√≠do, a partir da articula√ß√£o entre organiza√ß√µes com trajet√≥rias
 complementares na gest√£o de res√≠duos, na mobiliza√ß√£o social e na economia circular.</p>

<p>A <strong>M√£os Verdes</strong> contribui com sua experi√™ncia em educa√ß√£o ambiental, organiza√ß√£o comunit√°ria e 
  gest√£o de projetos sociais. </p>
 <p>A <strong>H√©lice</strong> atua na articula√ß√£o institucional, na gest√£o estrat√©gica e na conex√£o com pol√≠ticas p√∫blicas.</p>
 <p>A <strong>VAUS</strong> aporta intelig√™ncia t√©cnica, vis√£o sist√™mica e metodologias de economia circular aplicadas aos territ√≥rios. </p>

<p>Juntas, essas organiza√ß√µes estruturam o Hub como uma plataforma viva, conectada aos <strong>Centros de Refer√™ncia na Gest√£o 
  de Res√≠duos (CRGR)</strong>, fortalecendo a reciclagem, a economia circular e a capacidade dos territ√≥rios de se prevenir, 
  responder e se recuperar de eventos clim√°ticos.</p>

 <p>Mais do que uma plataforma, o Hub √© uma rede.</p>
 <p>Uma rede que acredita que cidades mais resilientes se constroem com participa√ß√£o, informa√ß√£o acess√≠vel e a√ß√£o coletiva.</p>

                </p>
                <div class="pillrow" aria-label="Pilares">
                  <span class="pill">Sustentabilidade real</span>
                  <span class="pill">Economia circular</span>
                  <span class="pill">Governan√ßa</span>
                  <span class="pill">Capacita√ß√£o</span>
                  <span class="pill">Dados & impacto</span>
                </div>
              </div>

              <div class="demoBox">
                <h3 style="font-size:14px;">Demonstrativos</h3>
                <div class="muted" style="margin-top:6px;">Exemplos do que o hub oferece (placeholder)</div>

                <div class="demoList">
                  <div class="demoItem">
                    <b>Boletins e atualiza√ß√µes</b>
                    <span>Feed geral</span>
                  </div>
                  <div class="demoItem">
                    <b>Mapeamento CRGR</b>
                    <span>Territ√≥rios</span>
                  </div>
                  <div class="demoItem">
                    <b>Trilhas formativas</b>
                    <span>Conte√∫dos</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 2) PAINEL DE ACOMPANHAMENTO -->
        <section class="card" id="monitorCard" translate="no">
          <div class="cardHead">
            <div>
              <h3>Painel de acompanhamento</h3>
              <div class="muted">CRGR, usu√°rios, planos e alertas</div>
            </div>
            <button class="pillbtn" id="refreshBtn" type="button">Atualizar</button>
          </div>

          <div class="cardBody">
            <div class="kpis">
              <div class="kpi">
                <div class="label">CRGR ativos</div>
                <div class="value" id="kpiCrgr">‚Äî</div>
                <div class="hint">Total em /crgrs</div>
              </div>
              <div class="kpi">
                <div class="label">Usu√°rios cadastrados</div>
                <div class="value" id="kpiUsers">‚Äî</div>
                <div class="hint">Total em /users</div>
              </div>
              <div class="kpi">
                <div class="label">Planos de a√ß√£o em andamento</div>
                <div class="value" id="kpiPlans">‚Äî</div>
                <div class="hint">Placeholder: /plans (status)</div>
              </div>
              <div class="kpi">
                <div class="label">Alertas cr√≠ticos</div>
                <div class="value" id="kpiAlerts">‚Äî</div>
                <div class="hint">Placeholder: /alerts</div>
              </div>
            </div>

            <div class="alerts" id="alertsBox">
              <b>Indicadores cr√≠ticos:</b> ainda n√£o configurados. (Quando criarmos a cole√ß√£o <code>alerts</code>,
              este espa√ßo mostra os alertas do territ√≥rio e do hub.)
            </div>
          </div>
        </section>

        <!-- 3) FEEDS -->
        <div class="empty" id="infoBox" translate="no">Carregando...</div>
        <section class="feed" id="feed"></section>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      orderBy,
      limit,
      getDocs,
      setDoc,
      deleteDoc,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8LPTZD7LA_CW2fOnJXJlVe6pByLyrRzo",
      authDomain: "hub-resiliencia-climatica.firebaseapp.com",
      projectId: "hub-resiliencia-climatica",
      storageBucket: "hub-resiliencia-climatica.firebasestorage.app",
      messagingSenderId: "485694309026",
      appId: "1:485694309026:web:771ed497d49861fa444dfb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ====== Permiss√µes
    const DEFAULT_MODULES_BY_ROLE = {
      comunidade: { feed:true, territorio:true, biblioteca:true, forum:true, agenda:false, planos:false, dashboards:false, admin:false },
      lideranca:  { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:false, admin:false },
      tecnico:    { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  admin:false },
      gestor:     { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  admin:false },
      admin:      { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  admin:true  }
    };

    function resolveModules(profile){
      const role = (profile?.role || "comunidade").toString();
      const defaults = DEFAULT_MODULES_BY_ROLE[role] || DEFAULT_MODULES_BY_ROLE.comunidade;
      const custom = (profile?.modules && typeof profile.modules === "object") ? profile.modules : {};
      return { ...defaults, ...custom };
    }
    function isAdmin(profile){
      const m = resolveModules(profile);
      return profile?.role === "admin" || m.admin === true;
    }
    function canAccess(profile, key){
      const m = resolveModules(profile);
      return m[key] === true;
    }

    // ===== UI refs
    const avatarBox = document.getElementById("avatarBox");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const userEmailEl = document.getElementById("userEmail");
    const userBioEl = document.getElementById("userBio");
    const userCrgrEl = document.getElementById("userCrgr");
    const userOrgEl = document.getElementById("userOrg");
    const navMenu = document.getElementById("navMenu");

    const feedEl = document.getElementById("feed");
    const infoBox = document.getElementById("infoBox");
    const searchInput = document.getElementById("searchInput");
    const adminBtn = document.getElementById("adminBtn");
    const subtitleEl = document.getElementById("subtitle");

    // KPIs
    const kpiCrgr = document.getElementById("kpiCrgr");
    const kpiUsers = document.getElementById("kpiUsers");
    const kpiPlans = document.getElementById("kpiPlans");
    const kpiAlerts = document.getElementById("kpiAlerts");
    const alertsBox = document.getElementById("alertsBox");

    const refreshBtn = document.getElementById("refreshBtn");
    const learnMoreBtn = document.getElementById("learnMoreBtn");

    let sessionUser = null;
    let sessionProfile = null;
    let feedCache = [];

    function initialsFrom(str){
      const s = (str || "").trim();
      if(!s) return "HR";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function setAvatar(photoURL, fallback){
      avatarBox.innerHTML = "";
      if(photoURL){
        const img = document.createElement("img");
        img.src = photoURL;
        img.alt = "Avatar";
        avatarBox.appendChild(img);
      }else{
        avatarBox.textContent = fallback;
      }
    }

    function safeStr(v){ return (v ?? "").toString(); }

    function fmtDate(ts){
      try{
        if(!ts) return "‚Äî";
        if(ts.toDate) return ts.toDate().toLocaleString("pt-BR");
        return String(ts);
      }catch{ return "‚Äî"; }
    }

    function renderMenu(modulesResolved){
      const items = [
        { key:"feed", label:"In√≠cio (Feed)", href:"home.html" },
        { key:"territorio", label:"Meu territ√≥rio / CRGR", href:"territorio.html" },
        { key:"planos", label:"Planos de a√ß√£o", href:"#", disabled:true },
        { key:"biblioteca", label:"Biblioteca", href:"#", disabled:true },
        { key:"agenda", label:"Agenda", href:"#", disabled:true },
        { key:"forum", label:"F√≥rum", href:"#", disabled:true },
        { key:"dashboards", label:"Dashboards", href:"#", disabled:true }
      ];

      navMenu.innerHTML = "";

      items.forEach((it) => {
        if(modulesResolved[it.key] !== true) return;
        const a = document.createElement("a");
        a.href = it.href;
        a.className = (it.key === "feed") ? "active" : "";
        a.innerHTML = `<span class="dot"></span> ${it.label}`;
        navMenu.appendChild(a);
      });

      if(isAdmin(sessionProfile)){
        const a = document.createElement("a");
        a.href = "admin.html";
        a.innerHTML = `<span class="dot"></span> Painel de administra√ß√£o`;
        navMenu.appendChild(a);
        adminBtn.style.display = "inline-flex";
        adminBtn.onclick = () => window.location.href = "admin.html";
      }else{
        adminBtn.style.display = "none";
      }
    }

    // ===== KPI loaders (simples, sem √≠ndice composto)
    async function countCollection(colName, max=500){
      const snap = await getDocs(query(collection(db, colName), limit(max)));
      return snap.size;
    }

    async function loadKPIs(){
      try{
        const [crgrCount, usersCount] = await Promise.all([
          countCollection("crgrs", 500),
          countCollection("users", 1000)
        ]);

        kpiCrgr.textContent = String(crgrCount);
        kpiUsers.textContent = String(usersCount);

        // placeholders (vamos ligar depois)
        kpiPlans.textContent = "‚Äî";
        kpiAlerts.textContent = "‚Äî";
      }catch(err){
        console.error(err);
        kpiCrgr.textContent = "‚Äî";
        kpiUsers.textContent = "‚Äî";
      }
    }

    // ===== POSTS (SEM where + SEM √≠ndice composto)
    async function fetchAllPosts(){
      try{
        const qAll = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(60));
        const snap = await getDocs(qAll);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }catch(err){
        const qFallback = query(collection(db, "posts"), limit(60));
        const snap2 = await getDocs(qFallback);
        const arr = snap2.docs.map(d => ({ id: d.id, ...d.data() }));
        arr.sort((a,b) => {
          const at = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
          const bt = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
          return bt - at;
        });
        return arr;
      }
    }

    async function getLikeCount(postId){
      const likesCol = collection(db, "posts", postId, "likes");
      const snap = await getDocs(query(likesCol, limit(200)));
      return snap.size;
    }

    async function hasUserLiked(postId, uid){
      const ref = doc(db, "posts", postId, "likes", uid);
      const snap = await getDoc(ref);
      return snap.exists();
    }

    async function toggleLike(postId, uid){
      const ref = doc(db, "posts", postId, "likes", uid);
      const snap = await getDoc(ref);
      if(snap.exists()){
        await deleteDoc(ref);
        return false;
      }else{
        await setDoc(ref, { uid, createdAt: serverTimestamp() });
        return true;
      }
    }

    async function loadComments(postId){
      const colRef = collection(db, "posts", postId, "comments");
      const snap = await getDocs(query(colRef, limit(50)));
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      arr.sort((a,b) => {
        const at = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const bt = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return bt - at;
      });
      return arr;
    }

    async function addComment(postId, user, profile, text){
      const colRef = collection(db, "posts", postId, "comments");
      const authorName = profile.name || user.displayName || (user.email ? user.email.split("@")[0] : "Usu√°rio");
      await addDoc(colRef, {
        authorUid: user.uid,
        authorName,
        text,
        createdAt: serverTimestamp()
      });
    }

    function postAvatarEl(post){
      const box = document.createElement("div");
      box.className = "post-avatar";
      if(post.authorPhotoURL){
        const img = document.createElement("img");
        img.src = post.authorPhotoURL;
        img.alt = "Autor";
        box.appendChild(img);
      }else{
        box.textContent = initialsFrom(post.authorName || "Autor");
      }
      return box;
    }

    async function renderFeed(list){
      feedEl.innerHTML = "";
      infoBox.style.display = "none";

      if(!list.length){
        infoBox.style.display = "block";
        infoBox.textContent = "Ainda n√£o h√° publica√ß√µes no feed.";
        return;
      }

      for(const post of list){
        const card = document.createElement("article");
        card.className = "post";

        const head = document.createElement("div");
        head.className = "post-head";
        head.appendChild(postAvatarEl(post));

        const meta = document.createElement("div");
        meta.className = "post-meta";
        meta.innerHTML = `
          <strong>${safeStr(post.authorName || "Admin")}</strong>
          <span>${safeStr(post.authorRole || "‚Äî")} ‚Ä¢ ${fmtDate(post.createdAt)}</span>
        `;
        head.appendChild(meta);

        const body = document.createElement("div");
        body.className = "post-body";
        body.textContent = safeStr(post.text || "");

        const tagsWrap = document.createElement("div");
        tagsWrap.className = "tags";
        const tags = Array.isArray(post.tags) ? post.tags : [];
        tags.slice(0, 10).forEach(t => {
          const el = document.createElement("span");
          el.className = "tag";
          el.textContent = `#${t}`;
          tagsWrap.appendChild(el);
        });

        const actions = document.createElement("div");
        actions.className = "post-actions";

        const likeBtn = document.createElement("button");
        likeBtn.className = "iconbtn";
        likeBtn.type = "button";
        likeBtn.textContent = "ü§ç Curtir";

        const commentsBtn = document.createElement("button");
        commentsBtn.className = "iconbtn";
        commentsBtn.type = "button";
        commentsBtn.textContent = "üí¨ Coment√°rios";

        const likeCountEl = document.createElement("span");
        likeCountEl.className = "muted";
        likeCountEl.style.marginLeft = "auto";

        actions.appendChild(likeBtn);
        actions.appendChild(commentsBtn);
        actions.appendChild(likeCountEl);

        const cbox = document.createElement("div");
        cbox.className = "commentbox";

        const cInput = document.createElement("textarea");
        cInput.placeholder = "Escreva um coment√°rio...";
        cInput.style.width = "100%";
        cInput.style.padding = "12px";
        cInput.style.borderRadius = "14px";
        cInput.style.border = "1px solid var(--border)";
        cInput.style.marginTop = "10px";
        cInput.style.minHeight = "78px";

        const cRow = document.createElement("div");
        cRow.style.display = "flex";
        cRow.style.gap = "10px";
        cRow.style.marginTop = "10px";

        const mkBtn = (label) => {
          const b = document.createElement("button");
          b.className = "pillbtn";
          b.type = "button";
          b.textContent = label;
          return b;
        };

        const cSend = mkBtn("Publicar coment√°rio");
        const cClose = mkBtn("Fechar");

        cRow.appendChild(cSend);
        cRow.appendChild(cClose);

        const cList = document.createElement("div");
        cList.className = "commentlist";

        cbox.appendChild(cInput);
        cbox.appendChild(cRow);
        cbox.appendChild(cList);

        card.appendChild(head);
        card.appendChild(body);
        if(tags.length) card.appendChild(tagsWrap);
        card.appendChild(actions);
        card.appendChild(cbox);

        feedEl.appendChild(card);

        const [count, liked] = await Promise.all([
          getLikeCount(post.id),
          hasUserLiked(post.id, sessionUser.uid)
        ]);
        likeCountEl.textContent = `${count} curtida(s)`;
        likeBtn.textContent = liked ? "‚ù§Ô∏è Curtido" : "ü§ç Curtir";

        likeBtn.addEventListener("click", async () => {
          const nowLiked = await toggleLike(post.id, sessionUser.uid);
          likeBtn.textContent = nowLiked ? "‚ù§Ô∏è Curtido" : "ü§ç Curtir";
          likeCountEl.textContent = `${await getLikeCount(post.id)} curtida(s)`;
        });

        commentsBtn.addEventListener("click", async () => {
          cbox.classList.add("show");
          cList.innerHTML = `<div class="muted">Carregando coment√°rios...</div>`;
          const comments = await loadComments(post.id);

          if(!comments.length){
            cList.innerHTML = `<div class="muted">Nenhum coment√°rio ainda.</div>`;
          }else{
            cList.innerHTML = "";
            comments.forEach(c => {
              const el = document.createElement("div");
              el.className = "comment";
              el.innerHTML = `
                <strong>${safeStr(c.authorName || "Usu√°rio")}</strong>
                <span>${safeStr(c.text || "")}</span>
                <small>${fmtDate(c.createdAt)}</small>
              `;
              cList.appendChild(el);
            });
          }
        });

        cClose.addEventListener("click", () => cbox.classList.remove("show"));

        cSend.addEventListener("click", async () => {
          const text = cInput.value.trim();
          if(!text) return;
          await addComment(post.id, sessionUser, sessionProfile, text);
          cInput.value = "";
          const comments = await loadComments(post.id);
          cList.innerHTML = comments.length ? "" : `<div class="muted">Nenhum coment√°rio ainda.</div>`;
          comments.forEach(c => {
            const el = document.createElement("div");
            el.className = "comment";
            el.innerHTML = `
              <strong>${safeStr(c.authorName || "Usu√°rio")}</strong>
              <span>${safeStr(c.text || "")}</span>
              <small>${fmtDate(c.createdAt)}</small>
            `;
            cList.appendChild(el);
          });
        });
      }
    }

    function filterFeedLocal(q){
      const s = safeStr(q).trim().toLowerCase();
      if(!s) return feedCache;
      return feedCache.filter(p => {
        const hay = [
          p.authorName, p.authorRole, p.text,
          Array.isArray(p.tags) ? p.tags.join(" ") : ""
        ].join(" ").toLowerCase();
        return hay.includes(s);
      });
    }

    async function loadFeed(){
      infoBox.style.display = "block";
      infoBox.textContent = "Carregando posts...";
      try{
        feedCache = await fetchAllPosts();
        await renderFeed(feedCache);
      }catch(err){
        console.error(err);
        infoBox.style.display = "block";
        infoBox.textContent = "Erro ao carregar o feed. Verifique permiss√µes / regras.";
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "index.html";
        return;
      }
      sessionUser = user;

      const uref = doc(db, "users", user.uid);
      const usnap = await getDoc(uref);

      let profile = {};
      if(!usnap.exists()){
        await setDoc(uref, {
          uid: user.uid,
          email: user.email ?? null,
          name: user.displayName || (user.email ? user.email.split("@")[0] : "Usu√°rio"),
          role: "comunidade",
          crgrIds: [],
          orgId: null,
          modules: {},
          bio: "Mini bio: descreva sua atua√ß√£o no territ√≥rio.",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        const again = await getDoc(uref);
        profile = again.data();
      }else{
        profile = usnap.data();
      }

      sessionProfile = profile;

      const name = profile.name || user.displayName || (user.email ? user.email.split("@")[0] : "Usu√°rio");
      const role = profile.role || "comunidade";
      const bio  = profile.bio || "Mini bio: descreva sua atua√ß√£o no territ√≥rio.";
      const crgr = Array.isArray(profile.crgrIds) && profile.crgrIds.length ? profile.crgrIds.join(", ") : "‚Äî";
      const org  = profile.orgId || "‚Äî";

      userNameEl.textContent = name;
      userRoleEl.textContent = `Perfil: ${role}`;
      userEmailEl.textContent = user.email || "‚Äî";
      userBioEl.textContent = bio;
      userCrgrEl.textContent = crgr;
      userOrgEl.textContent = org;

      setAvatar(user.photoURL || profile.photoURL || null, initialsFrom(name));

      const modulesResolved = resolveModules(profile);
      renderMenu(modulesResolved);

      // KPIs
      await loadKPIs();

      // BLOQUEIO DO FEED
      if(!canAccess(profile, "feed")){
        subtitleEl.textContent = "Feed bloqueado para seu perfil";
        infoBox.style.display = "block";
        infoBox.textContent = "Voc√™ n√£o tem permiss√£o para visualizar o feed.";
        feedEl.innerHTML = "";
        return;
      }

      subtitleEl.textContent = "Hub ‚Ä¢ Vis√£o geral";
      await loadFeed();

      searchInput.addEventListener("input", async () => {
        const filtered = filterFeedLocal(searchInput.value);
        await renderFeed(filtered);
      });
    });

    // Actions
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    refreshBtn.addEventListener("click", async () => {
      await loadKPIs();
      await loadFeed();
    });

    learnMoreBtn.addEventListener("click", () => {
      alert("Aqui podemos abrir uma p√°gina 'sobre.html' ou um modal com mais informa√ß√µes do projeto.");
    });
  </script>
</body>
</html>
