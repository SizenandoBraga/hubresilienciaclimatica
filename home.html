<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub Resili√™ncia Clim√°tica ‚Ä¢ In√≠cio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green-regen:#1B7F5A;
      --green-light:#4CAF8F;
      --blue-deep:#0D3B66;
      --yellow:#F2C94C;
      --graphite:#2E2E2E;
      --bg:#F5F7F6;
      --white:#FFFFFF;
      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --border:#E7ECEA;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--graphite);
    }
    h1,h2,h3{ font-family:'Poppins', sans-serif; margin:0; }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea { font-family:inherit; }

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:16px;
      height: calc(100vh - 32px);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(13,59,102,0.98), rgba(27,127,90,0.98));
      box-shadow: var(--shadow);
      color:#fff;
      padding:14px;
      overflow:hidden;
    }

    .sidebar-title{
      padding:10px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.14);
      margin-bottom:12px;
    }
    .sidebar-title strong{ display:block; font-size:15px; letter-spacing:0.2px; }
    .sidebar-title span{ display:block; font-size:12.5px; opacity:.9; margin-top:4px; }

    .profile{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
    }

    .avatar{
      width:56px;
      height:56px;
      border-radius:999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-family:'Poppins';
      letter-spacing:0.4px;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pmeta{ min-width:0; display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .pmeta strong{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pmeta .sub{ font-size:12px; opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .bio{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,0.10);
      border: 1px dashed rgba(255,255,255,0.20);
      font-size:12.5px;
      line-height:1.45;
      opacity:.95;
    }

    .chips{ margin-top:10px; display:grid; gap:8px; }
    .chip{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12.5px;
    }
    .chip strong{ font-family:'Poppins'; font-size:12px; }
    .chip span{
      opacity:.95;
      text-align:right;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 170px;
    }

    .nav{ margin-top:12px; display:grid; gap:6px; }
    .nav a{
      cursor:pointer;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      text-align:left;
      border: 1px solid transparent;
      opacity:.96;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav a:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.12); }
    .nav .active{ background: rgba(242,201,76,0.14); border-color: rgba(242,201,76,0.28); }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 3px rgba(242,201,76,0.16);
      flex:0 0 auto;
    }

    .sidebar-bottom{
      position:absolute;
      left:14px;
      right:14px;
      bottom:12px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.14);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      opacity:.9;
    }
    .logoutBtn{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:left;
    }
    .logoutBtn:hover{ background: rgba(255,255,255,0.14); }

    /* Content */
    .content{ display:flex; flex-direction:column; gap:12px; }

    .topbar{
      position:sticky;
      top:16px;
      z-index:5;
      background: rgba(245,247,246,0.82);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar h2{ font-size:16px; }
    .muted{ color:#666; font-size:13px; line-height:1.5; }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
    }
    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size:14px;
    }

    .pillbtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      color:var(--blue-deep);
      cursor:pointer;
    }

    /* Instagram-like feed cards */
    .feed{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .post{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .post-head{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px 10px;
    }
    .post-avatar{
      width:40px;
      height:40px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(76,175,143,0.25), rgba(27,127,90,0.25));
      border:1px solid rgba(27,127,90,0.20);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-family:'Poppins';
      color:#0d3b66;
      flex:0 0 auto;
    }
    .post-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .post-meta{ min-width:0; flex:1; display:flex; flex-direction:column; gap:2px; }
    .post-meta strong{ font-size:13.5px; font-family:'Poppins'; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .post-meta span{ font-size:12px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .scope-badge{
      font-size:11px;
      font-weight:900;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(242,201,76,0.18);
      border: 1px solid rgba(242,201,76,0.32);
      color:#5b4a12;
      white-space:nowrap;
    }

    .post-body{
      padding: 0 12px 12px;
      font-size:14px;
      line-height:1.55;
      color:#2E2E2E;
      white-space:pre-wrap;
    }

    .tags{
      padding: 0 12px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .tag{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:#0d3b66;
      font-weight:800;
    }

    .post-actions{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px 12px;
      border-top:1px solid var(--border);
    }
    .iconbtn{
      border:none;
      cursor:pointer;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .iconbtn:hover{
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
      transform: translateY(-1px);
    }
    .iconbtn:active{ transform: translateY(0); opacity:.92; }

    .commentbox{
      padding: 0 12px 12px;
      display:none;
    }
    .commentbox.show{ display:block; }

    .commentlist{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin: 10px 0 0;
      max-height: 220px;
      overflow:auto;
      padding-right:4px;
    }
    .comment{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .comment strong{ font-family:'Poppins'; font-size:12.5px; }
    .comment span{ display:block; font-size:12.5px; color:#2e2e2e; margin-top:2px; white-space:pre-wrap; }
    .comment small{ display:block; margin-top:6px; font-size:11.5px; color:#777; }

    .empty{
      padding:16px;
      border:1px dashed rgba(13,59,102,0.25);
      border-radius:18px;
      background:#fff;
      color:#4a4a4a;
      font-size:13px;
      line-height:1.5;
    }

    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .topbar{ top:12px; }
      .sidebar-bottom{ position:relative; left:0; right:0; bottom:0; margin-top:12px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-title" translate="no">
        <strong>Hub Resili√™ncia Clim√°tica</strong>
        <span>Reciclagem ‚Ä¢ Territ√≥rios ‚Ä¢ Impacto</span>
      </div>

      <div class="profile" aria-label="Perfil do usu√°rio" translate="no">
        <div class="avatar" id="avatarBox">HR</div>
        <div class="pmeta">
          <strong id="userName">Carregando...</strong>
          <div class="sub" id="userRole">Perfil: ‚Äî</div>
          <div class="sub" id="userEmail">‚Äî</div>
        </div>
      </div>

      <div class="bio" id="userBio" translate="no">Carregando mini bio...</div>

      <div class="chips" aria-label="Atribui√ß√µes" translate="no">
        <div class="chip"><strong>CRGR</strong> <span id="userCrgr">‚Äî</span></div>
        <div class="chip"><strong>Organiza√ß√£o</strong> <span id="userOrg">‚Äî</span></div>
      </div>

      <nav class="nav" id="navMenu" aria-label="Menu lateral" translate="no"></nav>

      <div class="sidebar-bottom">
        <button id="logoutBtn" class="logoutBtn" translate="no">
          <span class="dot"></span> Sair
        </button>
        <div translate="no">Plataforma Regenera ‚Ä¢ v0.1</div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar" translate="no">
        <div style="min-width:220px;">
          <h2>In√≠cio</h2>
          <div class="muted" id="subtitle">Atualiza√ß√µes do seu territ√≥rio e CRGR</div>
        </div>

        <div class="search" aria-label="Pesquisar">
          <span style="opacity:.65;">üîé</span>
          <input id="searchInput" placeholder="Pesquisar no feed..." translate="no" />
        </div>

        <button class="pillbtn" id="adminBtn" type="button" style="display:none;" translate="no">Admin</button>
      </div>

      <div class="empty" id="infoBox" translate="no">
        Carregando posts...
      </div>

      <section class="feed" id="feed"></section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      setDoc,
      deleteDoc,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8LPTZD7LA_CW2fOnJXJlVe6pByLyrRzo",
      authDomain: "hub-resiliencia-climatica.firebaseapp.com",
      projectId: "hub-resiliencia-climatica",
      storageBucket: "hub-resiliencia-climatica.firebasestorage.app",
      messagingSenderId: "485694309026",
      appId: "1:485694309026:web:771ed497d49861fa444dfb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const avatarBox = document.getElementById("avatarBox");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const userEmailEl = document.getElementById("userEmail");
    const userBioEl = document.getElementById("userBio");
    const userCrgrEl = document.getElementById("userCrgr");
    const userOrgEl = document.getElementById("userOrg");
    const navMenu = document.getElementById("navMenu");
    const feedEl = document.getElementById("feed");
    const infoBox = document.getElementById("infoBox");
    const searchInput = document.getElementById("searchInput");
    const adminBtn = document.getElementById("adminBtn");
    const subtitle = document.getElementById("subtitle");

    let sessionUser = null;
    let sessionProfile = null;
    let feedCache = [];

    function initialsFrom(str){
      const s = (str || "").trim();
      if(!s) return "HR";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    function setAvatar(photoURL, fallback){
      avatarBox.innerHTML = "";
      if(photoURL){
        const img = document.createElement("img");
        img.src = photoURL;
        img.alt = "Avatar";
        avatarBox.appendChild(img);
      }else{
        avatarBox.textContent = fallback;
      }
    }
    function safeStr(v){ return (v ?? "").toString(); }
    function fmtDate(ts){
      try{
        if(!ts) return "‚Äî";
        if(ts.toDate) return ts.toDate().toLocaleString("pt-BR");
        return String(ts);
      }catch{ return "‚Äî"; }
    }

    function renderMenu(modules = {}, role = "comunidade"){
      const items = [
        { key:"feed", label:"In√≠cio (Feed)", href:"home.html", defaultOn:true },
        { key:"territorio", label:"Meu territ√≥rio / CRGR", href:"#", defaultOn:false },
        { key:"planos", label:"Planos de a√ß√£o", href:"#", defaultOn:false },
        { key:"biblioteca", label:"Biblioteca", href:"#", defaultOn:false },
        { key:"agenda", label:"Agenda", href:"#", defaultOn:false },
        { key:"forum", label:"F√≥rum", href:"#", defaultOn:false },
        { key:"dashboards", label:"Dashboards", href:"#", defaultOn:false }
      ];

      const isAdmin = role === "admin" || modules.admin === true;
      if(isAdmin){
        items.push({ key:"admin", label:"Painel de administra√ß√£o", href:"admin.html", defaultOn:true });
        adminBtn.style.display = "inline-flex";
        adminBtn.onclick = () => window.location.href = "admin.html";
      }

      navMenu.innerHTML = "";
      items.forEach((it, idx) => {
        const allowed = (modules[it.key] === true) || it.defaultOn === true;
        if(!allowed) return;
        const a = document.createElement("a");
        a.href = it.href;
        a.className = idx === 0 ? "active" : "";
        a.innerHTML = `<span class="dot"></span> ${it.label}`;
        navMenu.appendChild(a);
      });
    }

    // ===== Feed queries (global + crgr)
    async function fetchFeedPostsForUser(profile){
      const crgrIds = Array.isArray(profile.crgrIds) ? profile.crgrIds.filter(Boolean) : [];
      subtitle.textContent = crgrIds.length
        ? `Atualiza√ß√µes do(s) seu(s) CRGR: ${crgrIds.join(", ")}`
        : "Atualiza√ß√µes globais (sem CRGR associado)";

      const results = [];

      // 1) global
      const qGlobal = query(
        collection(db, "posts"),
        where("scope.type", "==", "global"),
        orderBy("createdAt", "desc"),
        limit(30)
      );
      const snapG = await getDocs(qGlobal);
      snapG.docs.forEach(d => results.push({ id: d.id, ...d.data() }));

      // 2) crgr
      // OBS: array-contains-any limita 10 valores
      if(crgrIds.length){
        const slice = crgrIds.slice(0, 10);
        const qCrgr = query(
          collection(db, "posts"),
          where("scope.type", "==", "crgr"),
          where("scope.crgrIds", "array-contains-any", slice),
          orderBy("createdAt", "desc"),
          limit(50)
        );
        const snapC = await getDocs(qCrgr);
        snapC.docs.forEach(d => results.push({ id: d.id, ...d.data() }));
      }

      // remove duplicados e ordena por createdAt desc
      const seen = new Set();
      const merged = [];
      for(const p of results){
        if(seen.has(p.id)) continue;
        seen.add(p.id);
        merged.push(p);
      }

      merged.sort((a,b) => {
        const at = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const bt = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return bt - at;
      });

      return merged.slice(0, 60);
    }

    // ===== Likes / Comments (MVP)
    async function getLikeCount(postId){
      const likesCol = collection(db, "posts", postId, "likes");
      const snap = await getDocs(query(likesCol, limit(200))); // MVP
      return snap.size;
    }

    async function hasUserLiked(postId, uid){
      const ref = doc(db, "posts", postId, "likes", uid);
      const snap = await getDoc(ref);
      return snap.exists();
    }

    async function toggleLike(postId, uid){
      const ref = doc(db, "posts", postId, "likes", uid);
      const snap = await getDoc(ref);
      if(snap.exists()){
        await deleteDoc(ref);
        return false;
      }else{
        await setDoc(ref, { uid, createdAt: serverTimestamp() });
        return true;
      }
    }

    async function loadComments(postId){
      const colRef = collection(db, "posts", postId, "comments");
      const snap = await getDocs(query(colRef, orderBy("createdAt", "desc"), limit(50)));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function addComment(postId, user, profile, text){
      const colRef = collection(db, "posts", postId, "comments");
      const authorName = profile.name || user.displayName || (user.email ? user.email.split("@")[0] : "Usu√°rio");
      await addDoc(colRef, {
        authorUid: user.uid,
        authorName,
        text,
        createdAt: serverTimestamp()
      });
    }

    function scopeBadge(post){
      const type = post?.scope?.type || "global";
      if(type === "crgr"){
        const ids = Array.isArray(post.scope?.crgrIds) ? post.scope.crgrIds : [];
        return `CRGR: ${ids.join(", ") || "‚Äî"}`;
      }
      return "Global";
    }

    function postAvatarEl(post){
      const box = document.createElement("div");
      box.className = "post-avatar";

      if(post.authorPhotoURL){
        const img = document.createElement("img");
        img.src = post.authorPhotoURL;
        img.alt = "Autor";
        box.appendChild(img);
      }else{
        box.textContent = initialsFrom(post.authorName || "Autor");
      }
      return box;
    }

    async function renderFeed(list){
      feedEl.innerHTML = "";
      infoBox.style.display = "none";

      if(!list.length){
        infoBox.style.display = "block";
        infoBox.textContent = "Ainda n√£o h√° publica√ß√µes para o seu CRGR. Aguarde conte√∫dos do administrador.";
        return;
      }

      for(const post of list){
        const card = document.createElement("article");
        card.className = "post";

        // header
        const head = document.createElement("div");
        head.className = "post-head";
        head.appendChild(postAvatarEl(post));

        const meta = document.createElement("div");
        meta.className = "post-meta";
        meta.innerHTML = `
          <strong>${safeStr(post.authorName || "Admin")}</strong>
          <span>${safeStr(post.authorRole || "‚Äî")} ‚Ä¢ ${fmtDate(post.createdAt)}</span>
        `;

        const badge = document.createElement("div");
        badge.className = "scope-badge";
        badge.textContent = scopeBadge(post);

        head.appendChild(meta);
        head.appendChild(badge);

        // body
        const body = document.createElement("div");
        body.className = "post-body";
        body.textContent = safeStr(post.text || "");

        // tags
        const tagsWrap = document.createElement("div");
        tagsWrap.className = "tags";
        const tags = Array.isArray(post.tags) ? post.tags : [];
        tags.slice(0, 10).forEach(t => {
          const el = document.createElement("span");
          el.className = "tag";
          el.textContent = `#${t}`;
          tagsWrap.appendChild(el);
        });

        // actions
        const actions = document.createElement("div");
        actions.className = "post-actions";

        const likeBtn = document.createElement("button");
        likeBtn.className = "iconbtn";
        likeBtn.type = "button";
        likeBtn.textContent = "ü§ç Curtir";

        const likeCountEl = document.createElement("span");
        likeCountEl.className = "muted";
        likeCountEl.style.marginLeft = "auto";

        const commentsBtn = document.createElement("button");
        commentsBtn.className = "iconbtn";
        commentsBtn.type = "button";
        commentsBtn.textContent = "üí¨ Coment√°rios";

        actions.appendChild(likeBtn);
        actions.appendChild(commentsBtn);
        actions.appendChild(likeCountEl);

        // comments box
        const cbox = document.createElement("div");
        cbox.className = "commentbox";

        const cInput = document.createElement("textarea");
        cInput.className = "textarea";
        cInput.placeholder = "Escreva um coment√°rio...";
        cInput.style.minHeight = "78px";

        const cRow = document.createElement("div");
        cRow.style.display = "flex";
        cRow.style.gap = "10px";
        cRow.style.marginTop = "10px";

        const cSend = document.createElement("button");
        cSend.className = "pillbtn";
        cSend.textContent = "Publicar coment√°rio";
        cSend.type = "button";

        const cClose = document.createElement("button");
        cClose.className = "pillbtn";
        cClose.textContent = "Fechar";
        cClose.type = "button";

        cRow.appendChild(cSend);
        cRow.appendChild(cClose);

        const cList = document.createElement("div");
        cList.className = "commentlist";

        cbox.appendChild(cInput);
        cbox.appendChild(cRow);
        cbox.appendChild(cList);

        // assemble
        card.appendChild(head);
        card.appendChild(body);
        if(tags.length) card.appendChild(tagsWrap);
        card.appendChild(actions);
        card.appendChild(cbox);
        feedEl.appendChild(card);

        // initial like state
        const [count, liked] = await Promise.all([
          getLikeCount(post.id),
          hasUserLiked(post.id, sessionUser.uid)
        ]);
        likeCountEl.textContent = `${count} curtida(s)`;
        likeBtn.textContent = liked ? "‚ù§Ô∏è Curtido" : "ü§ç Curtir";

        likeBtn.addEventListener("click", async () => {
          const nowLiked = await toggleLike(post.id, sessionUser.uid);
          likeBtn.textContent = nowLiked ? "‚ù§Ô∏è Curtido" : "ü§ç Curtir";
          const newCount = await getLikeCount(post.id);
          likeCountEl.textContent = `${newCount} curtida(s)`;
        });

        commentsBtn.addEventListener("click", async () => {
          cbox.classList.add("show");
          cList.innerHTML = `<div class="muted">Carregando coment√°rios...</div>`;
          const comments = await loadComments(post.id);

          if(!comments.length){
            cList.innerHTML = `<div class="muted">Nenhum coment√°rio ainda.</div>`;
          }else{
            cList.innerHTML = "";
            comments.forEach(c => {
              const el = document.createElement("div");
              el.className = "comment";
              el.innerHTML = `
                <strong>${safeStr(c.authorName || "Usu√°rio")}</strong>
                <span>${safeStr(c.text || "")}</span>
                <small>${fmtDate(c.createdAt)}</small>
              `;
              cList.appendChild(el);
            });
          }
        });

        cClose.addEventListener("click", () => {
          cbox.classList.remove("show");
        });

        cSend.addEventListener("click", async () => {
          const text = cInput.value.trim();
          if(!text) return;
          await addComment(post.id, sessionUser, sessionProfile, text);
          cInput.value = "";
          // reload
          const comments = await loadComments(post.id);
          cList.innerHTML = comments.length ? "" : `<div class="muted">Nenhum coment√°rio ainda.</div>`;
          comments.forEach(c => {
            const el = document.createElement("div");
            el.className = "comment";
            el.innerHTML = `
              <strong>${safeStr(c.authorName || "Usu√°rio")}</strong>
              <span>${safeStr(c.text || "")}</span>
              <small>${fmtDate(c.createdAt)}</small>
            `;
            cList.appendChild(el);
          });
        });
      }
    }

    function filterFeedLocal(q){
      const s = safeStr(q).trim().toLowerCase();
      if(!s) return feedCache;
      return feedCache.filter(p => {
        const hay = [
          p.authorName, p.authorRole, p.text,
          Array.isArray(p.tags) ? p.tags.join(" ") : "",
          p.scope?.type,
          Array.isArray(p.scope?.crgrIds) ? p.scope.crgrIds.join(" ") : ""
        ].join(" ").toLowerCase();
        return hay.includes(s);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "index.html";
        return;
      }
      sessionUser = user;

      // perfil do Firestore
      const uref = doc(db, "users", user.uid);
      const usnap = await getDoc(uref);
      const profile = usnap.exists() ? usnap.data() : {};
      sessionProfile = profile;

      const name = profile.name || user.displayName || (user.email ? user.email.split("@")[0] : "Usu√°rio");
      const role = profile.role || "comunidade";
      const bio  = profile.bio || "Mini bio: descreva sua atua√ß√£o no territ√≥rio.";
      const crgr = Array.isArray(profile.crgrIds) && profile.crgrIds.length ? profile.crgrIds.join(", ") : "‚Äî";
      const org  = profile.orgId || "‚Äî";

      userNameEl.textContent = name;
      userRoleEl.textContent = `Perfil: ${role}`;
      userEmailEl.textContent = user.email || "‚Äî";
      userBioEl.textContent = bio;
      userCrgrEl.textContent = crgr;
      userOrgEl.textContent = org;

      setAvatar(user.photoURL || profile.photoURL || null, initialsFrom(name));
      renderMenu(profile.modules || {}, role);

      // feed
      infoBox.style.display = "block";
      infoBox.textContent = "Carregando posts...";

      try{
        feedCache = await fetchFeedPostsForUser(profile);
        await renderFeed(feedCache);
      }catch(err){
        console.error(err);
        infoBox.style.display = "block";
        infoBox.textContent = "Erro ao carregar o feed. Verifique as Rules do Firestore e os √≠ndices.";
      }

      searchInput.addEventListener("input", async () => {
        const filtered = filterFeedLocal(searchInput.value);
        await renderFeed(filtered);
      });
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
