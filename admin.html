<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub Resili√™ncia Clim√°tica ‚Ä¢ Governan√ßa</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green-regen:#1B7F5A;
      --green-light:#4CAF8F;
      --blue-deep:#0D3B66;
      --yellow:#F2C94C;

      --graphite:#2E2E2E;
      --bg:#F5F7F6;
      --white:#FFFFFF;

      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --border:#E7ECEA;
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--graphite);
    }
    h1,h2,h3{ font-family:'Poppins', sans-serif; margin:0; }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea, select { font-family:inherit; }

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      padding:16px;
      max-width:1300px;
      margin:0 auto;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:16px;
      height: calc(100vh - 32px);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(13,59,102,0.98), rgba(27,127,90,0.98));
      box-shadow: var(--shadow);
      color:#fff;
      padding:14px;
      overflow:hidden;
    }

    .sidebar-title{
      padding:10px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.14);
      margin-bottom:12px;
    }
    .sidebar-title strong{ display:block; font-size:15px; letter-spacing:0.2px; }
    .sidebar-title span{ display:block; font-size:12.5px; opacity:.9; margin-top:4px; }

    .profile{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
    }
    .avatar{
      width:50px;
      height:50px;
      border-radius:999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-family:'Poppins';
      letter-spacing:0.4px;
      flex:0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pmeta{ min-width:0; display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .pmeta strong{ font-size:13.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pmeta .sub{ font-size:12px; opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .nav{
      margin-top:12px;
      display:grid;
      gap:6px;
    }
    .nav a{
      cursor:pointer;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      text-align:left;
      border: 1px solid transparent;
      opacity:.96;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav a:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.12); }
    .nav a.active{ background: rgba(242,201,76,0.14); border-color: rgba(242,201,76,0.28); }

    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 3px rgba(242,201,76,0.16);
      flex:0 0 auto;
    }

    .sidebar-bottom{
      position:absolute;
      left:14px;
      right:14px;
      bottom:12px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.14);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      opacity:.9;
    }
    .btnGhost{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:left;
    }
    .btnGhost:hover{ background: rgba(255,255,255,0.14); }

    /* Content */
    .content{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }

    /* TOPBAR (Governan√ßa) */
    .topbar{
      position:sticky;
      top:16px;
      z-index:5;
      background: rgba(245,247,246,0.82);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar h2{ font-size:16px; }
    .muted{ color:#666; font-size:13px; line-height:1.5; }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
      min-width: 240px;
    }
    .search input{ border:none; outline:none; width:100%; font-size:14px; }

    .pillbtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      color:var(--blue-deep);
      cursor:pointer;
      white-space:nowrap;
    }

    /* Sections */
    .section{
      display:none;
      gap:12px;
    }
    .section.active{ display:flex; flex-direction:column; }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .cardHead{
      padding:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
    }
    .cardHead h3{ font-size:14px; }
    .cardBody{ padding:14px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      background:#fff;
    }
    .kpi .label{ font-size:12px; color:#666; }
    .kpi .value{
      font-family:'Poppins';
      font-size:22px;
      margin-top:6px;
      letter-spacing:-0.02em;
    }
    .kpi .hint{ font-size:12px; color:#666; margin-top:6px; }

    .alertBox{
      margin-top:12px;
      border:1px solid rgba(242,201,76,0.35);
      background: rgba(242,201,76,0.16);
      border-radius:18px;
      padding:12px 14px;
      font-size:13px;
      line-height:1.5;
      color:#5b4a12;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--border);
      border-radius:16px;
    }
    .table th, .table td{
      padding:10px 12px;
      font-size:13px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    .table th{
      text-align:left;
      font-family:'Poppins';
      font-size:12.5px;
      background: rgba(245,247,246,0.75);
      color:#2e2e2e;
    }
    .table tr:last-child td{ border-bottom:none; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(76,175,143,0.12);
      color: var(--green-regen);
      border: 1px solid rgba(76,175,143,0.25);
      white-space:nowrap;
      font-weight:900;
      font-family:'Poppins';
    }

    .empty{
      padding:16px;
      border:1px dashed rgba(13,59,102,0.25);
      border-radius:18px;
      background:#fff;
      color:#4a4a4a;
      font-size:13px;
      line-height:1.5;
    }

    .rowActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .danger{
      background: rgba(208, 62, 62, 0.08);
      border-color: rgba(208, 62, 62, 0.18);
      color:#8a1f1f;
    }

    @media (max-width: 1100px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
      .grid2{ grid-template-columns: 1fr; }
    }
    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .sidebar-bottom{ position:relative; left:0; right:0; bottom:0; margin-top:12px; }
      .topbar{ top:12px; }
      .kpis{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- MENU LATERAL ‚Äì GOVERNAN√áA -->
    <aside class="sidebar">
      <div class="sidebar-title" translate="no">
        <strong>Governan√ßa</strong>
        <span>Hub Resili√™ncia Clim√°tica</span>
      </div>

      <div class="profile" aria-label="Perfil do administrador" translate="no">
        <div class="avatar" id="avatarBox">AD</div>
        <div class="pmeta">
          <strong id="adminName">Carregando...</strong>
          <div class="sub" id="adminRole">Perfil: ‚Äî</div>
          <div class="sub" id="adminEmail">‚Äî</div>
        </div>
      </div>

      <nav class="nav" id="navMenu" aria-label="Menu lateral" translate="no">
        <a class="active" data-page="dashboard" href="#"><span class="dot"></span> Painel geral</a>
        <a data-page="users" href="#"><span class="dot"></span> Gest√£o de Usu√°rios</a>
        <a data-page="feed" href="#"><span class="dot"></span> Feed (Posts)</a>
        <a data-page="territorios" href="#"><span class="dot"></span> Gest√£o de Territ√≥rios / CRGR</a>
        <a data-page="planos" href="#"><span class="dot"></span> Gest√£o de Planos de a√ß√£o</a>
        <a data-page="conteudos" href="#"><span class="dot"></span> Gest√£o de Conte√∫dos</a>
      </nav>

      <div class="sidebar-bottom">
        <button id="backHomeBtn" class="btnGhost" translate="no"><span class="dot"></span> Voltar para Home</button>
        <button id="logoutBtn" class="btnGhost" translate="no"><span class="dot"></span> Sair</button>
        <div translate="no">Plataforma Regenera ‚Ä¢ v0.1</div>
      </div>
    </aside>

    <!-- √ÅREA LOGADA GOVERNAN√áA -->
    <main class="content">
      <!-- TOPBAR -->
      <div class="topbar" translate="no">
        <div style="min-width:240px;">
          <h2 id="pageTitle">Painel geral</h2>
          <div class="muted" id="pageSubtitle">Vis√£o geral do Hub</div>
        </div>

        <div class="search" aria-label="Pesquisar">
          <span style="opacity:.65;">üîé</span>
          <input id="globalSearch" placeholder="Buscar no painel..." />
        </div>

        <div class="rowActions">
          <span class="badge" id="badgeStatus">Admin</span>
          <button class="pillbtn" id="refreshBtn" type="button">Atualizar</button>
        </div>
      </div>

      <!-- PAINEL GERAL -->
      <section class="section active" id="page-dashboard" translate="no">
        <div class="card">
          <div class="cardHead">
            <div>
              <h3>Painel Geral: Vis√£o geral do Hub</h3>
              <div class="muted">Painel de acompanhamento</div>
            </div>
          </div>
          <div class="cardBody">
            <div class="kpis">
              <div class="kpi">
                <div class="label">N¬∫ de CRGR ativos</div>
                <div class="value" id="kpiCrgr">‚Äî</div>
                <div class="hint">Cole√ß√£o: <code>crgrs</code></div>
              </div>
              <div class="kpi">
                <div class="label">N¬∫ de usu√°rios cadastrados</div>
                <div class="value" id="kpiUsers">‚Äî</div>
                <div class="hint">Cole√ß√£o: <code>users</code></div>
              </div>
              <div class="kpi">
                <div class="label">Planos de a√ß√£o em andamento</div>
                <div class="value" id="kpiPlans">‚Äî</div>
                <div class="hint">Placeholder: <code>plans</code> (status)</div>
              </div>
              <div class="kpi">
                <div class="label">Indicadores cr√≠ticos em alerta</div>
                <div class="value" id="kpiAlerts">‚Äî</div>
                <div class="hint">Placeholder: <code>alerts</code></div>
              </div>
            </div>

            <div class="alertBox" id="alertsBox">
              <b>Indicadores cr√≠ticos:</b> ainda n√£o configurados. (Quando criarmos a cole√ß√£o <code>alerts</code>,
              este espa√ßo vai listar alertas por territ√≥rio/CRGR.)
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <div>
                <h3>√öltimos usu√°rios cadastrados</h3>
                <div class="muted">Amostra (√∫ltimos 10)</div>
              </div>
              <button class="pillbtn" data-jump="users" type="button">Ver gest√£o</button>
            </div>
            <div class="cardBody">
              <div class="empty" id="dashUsersBox">Carregando...</div>
              <div id="dashUsersTableWrap" style="display:none;"></div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead">
              <div>
                <h3>√öltimas CRGR / cooperativas</h3>
                <div class="muted">Amostra (√∫ltimas 10)</div>
              </div>
              <button class="pillbtn" data-jump="territorios" type="button">Ver gest√£o</button>
            </div>
            <div class="cardBody">
              <div class="empty" id="dashCrgrBox">Carregando...</div>
              <div id="dashCrgrTableWrap" style="display:none;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- GEST√ÉO DE USU√ÅRIOS -->
      <section class="section" id="page-users" translate="no">
        <div class="card">
          <div class="cardHead">
            <div>
              <h3>Gest√£o de Usu√°rios</h3>
              <div class="muted">Listagem e edi√ß√£o de permiss√µes por perfil</div>
            </div>
            <div class="rowActions">
              <button class="pillbtn" id="reloadUsersBtn" type="button">Recarregar</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="empty" id="usersBox">Carregando usu√°rios...</div>
            <div id="usersTableWrap" style="display:none;"></div>
          </div>
        </div>
      </section>

      <!-- FEED (POSTS) -->
      <section class="section" id="page-feed" translate="no">
        <div class="card">
          <div class="cardHead">
            <div>
              <h3>Feed (Posts)</h3>
              <div class="muted">Somente admin cria/edita; usu√°rios visualizam</div>
            </div>
            <button class="pillbtn" id="reloadPostsBtn" type="button">Recarregar</button>
          </div>
          <div class="cardBody">
            <div class="empty">Aqui vamos colocar: lista de posts + bot√£o ‚ÄúCriar post‚Äù (admin) + modera√ß√£o.</div>
          </div>
        </div>
      </section>

      <!-- TERRIT√ìRIOS / CRGR -->
      <section class="section" id="page-territorios" translate="no">
        <div class="card">
          <div class="cardHead">
            <div>
              <h3>Gest√£o de Territ√≥rios / CRGR</h3>
              <div class="muted">Seleciona um territ√≥rio/CRGR e v√™ o dashboard (n¬∫ usu√°rios por territ√≥rio)</div>
            </div>
            <button class="pillbtn" id="reloadCrgrBtn" type="button">Recarregar</button>
          </div>
          <div class="cardBody">
            <div class="empty">
              Pr√≥ximo: criar <code>crgrs</code> (unidades/cooperativas) e <code>territorios</code>.
              Depois: selecionar CRGR e calcular <b>n¬∫ de usu√°rios</b> associados via <code>users.crgrIds</code>.
            </div>
          </div>
        </div>
      </section>

      <!-- PLANOS DE A√á√ÉO -->
      <section class="section" id="page-planos" translate="no">
        <div class="card">
          <div class="cardHead">
            <div>
              <h3>Gest√£o de Planos de a√ß√£o</h3>
              <div class="muted">Cria√ß√£o, status e acompanhamento</div>
            </div>
            <button class="pillbtn" type="button">Em breve</button>
          </div>
          <div class="cardBody">
            <div class="empty">Placeholder para cole√ß√£o <code>plans</code> (status: em_andamento, concluido, etc.).</div>
          </div>
        </div>
      </section>

      <!-- CONTE√öDOS -->
      <section class="section" id="page-conteudos" translate="no">
        <div class="card">
          <div class="cardHead">
            <div>
              <h3>Gest√£o de Conte√∫dos</h3>
              <div class="muted">Trilhas, biblioteca, materiais</div>
            </div>
            <button class="pillbtn" type="button">Em breve</button>
          </div>
          <div class="cardBody">
            <div class="empty">Placeholder para cole√ß√µes <code>contents</code> e <code>tracks</code>.</div>
          </div>
        </div>
      </section>

      <!-- ACESSO NEGADO -->
      <section class="section" id="page-denied" translate="no">
        <div class="card">
          <div class="cardHead">
            <div>
              <h3>Acesso negado</h3>
              <div class="muted">Voc√™ n√£o tem permiss√£o para acessar a governan√ßa.</div>
            </div>
          </div>
          <div class="cardBody">
            <div class="empty danger">
              Seu usu√°rio n√£o est√° com perfil <b>admin</b>. Pe√ßa para um administrador habilitar:
              <code>users/{uid}.role = "admin"</code> ou <code>users/{uid}.modules.admin = true</code>.
            </div>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="pillbtn" id="goHomeDenied" type="button">Voltar para Home</button>
              <button class="pillbtn" id="logoutDenied" type="button">Sair</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8LPTZD7LA_CW2fOnJXJlVe6pByLyrRzo",
      authDomain: "hub-resiliencia-climatica.firebaseapp.com",
      projectId: "hub-resiliencia-climatica",
      storageBucket: "hub-resiliencia-climatica.firebasestorage.app",
      messagingSenderId: "485694309026",
      appId: "1:485694309026:web:771ed497d49861fa444dfb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const avatarBox = document.getElementById("avatarBox");
    const adminName = document.getElementById("adminName");
    const adminRole = document.getElementById("adminRole");
    const adminEmail = document.getElementById("adminEmail");

    const pageTitle = document.getElementById("pageTitle");
    const pageSubtitle = document.getElementById("pageSubtitle");
    const globalSearch = document.getElementById("globalSearch");
    const refreshBtn = document.getElementById("refreshBtn");
    const badgeStatus = document.getElementById("badgeStatus");

    const kpiCrgr = document.getElementById("kpiCrgr");
    const kpiUsers = document.getElementById("kpiUsers");
    const kpiPlans = document.getElementById("kpiPlans");
    const kpiAlerts = document.getElementById("kpiAlerts");

    const dashUsersBox = document.getElementById("dashUsersBox");
    const dashUsersTableWrap = document.getElementById("dashUsersTableWrap");
    const dashCrgrBox = document.getElementById("dashCrgrBox");
    const dashCrgrTableWrap = document.getElementById("dashCrgrTableWrap");

    const usersBox = document.getElementById("usersBox");
    const usersTableWrap = document.getElementById("usersTableWrap");

    const reloadUsersBtn = document.getElementById("reloadUsersBtn");
    const reloadPostsBtn = document.getElementById("reloadPostsBtn");
    const reloadCrgrBtn = document.getElementById("reloadCrgrBtn");

    const backHomeBtn = document.getElementById("backHomeBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    let sessionUser = null;
    let sessionProfile = null;

    function safeStr(v){ return (v ?? "").toString(); }
    function initialsFrom(str){
      const s = (str || "").trim();
      if(!s) return "AD";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    function setAvatar(photoURL, fallback){
      avatarBox.innerHTML = "";
      if(photoURL){
        const img = document.createElement("img");
        img.src = photoURL;
        img.alt = "Avatar";
        avatarBox.appendChild(img);
      }else{
        avatarBox.textContent = fallback;
      }
    }

    function showPage(key){
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.querySelectorAll(".nav a").forEach(a => a.classList.remove("active"));

      const target = document.getElementById("page-" + key);
      if(target) target.classList.add("active");

      const nav = document.querySelector(`.nav a[data-page="${key}"]`);
      if(nav) nav.classList.add("active");

      const titles = {
        dashboard: { t:"Painel geral", s:"Vis√£o geral do Hub" },
        users: { t:"Gest√£o de Usu√°rios", s:"Cadastrados, perfis e permiss√µes" },
        feed: { t:"Feed (Posts)", s:"Publica√ß√µes e modera√ß√£o" },
        territorios: { t:"Territ√≥rios / CRGR", s:"Unidades, territ√≥rios e indicadores" },
        planos: { t:"Planos de a√ß√£o", s:"Acompanhamento e status" },
        conteudos: { t:"Conte√∫dos", s:"Trilhas, biblioteca e materiais" },
        denied: { t:"Acesso negado", s:"Sem permiss√£o para governan√ßa" }
      };

      const meta = titles[key] || titles.dashboard;
      pageTitle.textContent = meta.t;
      pageSubtitle.textContent = meta.s;
      globalSearch.value = "";
    }

    function isAdmin(profile){
      const role = (profile?.role || "").toString();
      const modules = (profile?.modules && typeof profile.modules === "object") ? profile.modules : {};
      return role === "admin" || modules.admin === true;
    }

    // KPIs simples (contagem por limite) ‚Äî ok para MVP
    async function countCollection(colName, max=1000){
      const snap = await getDocs(query(collection(db, colName), limit(max)));
      return snap.size;
    }

    async function loadKPIs(){
      try{
        const [crgrCount, usersCount] = await Promise.all([
          countCollection("crgrs", 1000),
          countCollection("users", 2000)
        ]);

        kpiCrgr.textContent = String(crgrCount);
        kpiUsers.textContent = String(usersCount);

        // placeholders (vamos ligar depois)
        kpiPlans.textContent = "‚Äî";
        kpiAlerts.textContent = "‚Äî";
      }catch(err){
        console.error(err);
        kpiCrgr.textContent = "‚Äî";
        kpiUsers.textContent = "‚Äî";
        kpiPlans.textContent = "‚Äî";
        kpiAlerts.textContent = "‚Äî";
      }
    }

    function renderSimpleTable(container, rows, cols){
      // cols: [{key,label,render?}]
      const table = document.createElement("table");
      table.className = "table";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c.label;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      rows.forEach(r => {
        const tr = document.createElement("tr");
        cols.forEach(c => {
          const td = document.createElement("td");
          td.textContent = c.render ? c.render(r) : safeStr(r[c.key]);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      container.innerHTML = "";
      container.appendChild(table);
    }

    async function loadDashboardTables(){
      // √öltimos usu√°rios (MVP: por updatedAt/createdAt se existir, sen√£o sem order)
      try{
        dashUsersBox.style.display = "block";
        dashUsersTableWrap.style.display = "none";
        dashUsersBox.textContent = "Carregando...";

        let users = [];
        try{
          const qUsers = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(10));
          const snap = await getDocs(qUsers);
          users = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        }catch{
          const snap = await getDocs(query(collection(db, "users"), limit(10)));
          users = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        }

        if(!users.length){
          dashUsersBox.textContent = "Nenhum usu√°rio encontrado.";
        }else{
          dashUsersBox.style.display = "none";
          dashUsersTableWrap.style.display = "block";
          renderSimpleTable(dashUsersTableWrap, users, [
            { key:"name", label:"Nome", render: r => safeStr(r.name || "‚Äî") },
            { key:"email", label:"E-mail", render: r => safeStr(r.email || "‚Äî") },
            { key:"role", label:"Perfil", render: r => safeStr(r.role || "comunidade") }
          ]);
        }
      }catch(err){
        console.error(err);
        dashUsersBox.textContent = "Erro ao carregar usu√°rios (dashboard).";
      }

      // √öltimas CRGR
      try{
        dashCrgrBox.style.display = "block";
        dashCrgrTableWrap.style.display = "none";
        dashCrgrBox.textContent = "Carregando...";

        let crgrs = [];
        try{
          const qCrgr = query(collection(db, "crgrs"), orderBy("createdAt", "desc"), limit(10));
          const snap = await getDocs(qCrgr);
          crgrs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        }catch{
          const snap = await getDocs(query(collection(db, "crgrs"), limit(10)));
          crgrs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        }

        if(!crgrs.length){
          dashCrgrBox.textContent = "Nenhuma CRGR cadastrada ainda.";
        }else{
          dashCrgrBox.style.display = "none";
          dashCrgrTableWrap.style.display = "block";
          renderSimpleTable(dashCrgrTableWrap, crgrs, [
            { key:"name", label:"CRGR / Unidade", render: r => safeStr(r.name || r.title || "‚Äî") },
            { key:"city", label:"Cidade", render: r => safeStr(r.city || "‚Äî") },
            { key:"state", label:"UF", render: r => safeStr(r.state || "‚Äî") }
          ]);
        }
      }catch(err){
        console.error(err);
        dashCrgrBox.textContent = "Erro ao carregar CRGRs (dashboard).";
      }
    }

    async function loadUsersPage(){
      try{
        usersBox.style.display = "block";
        usersTableWrap.style.display = "none";
        usersBox.textContent = "Carregando usu√°rios...";

        let users = [];
        try{
          const qUsers = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(60));
          const snap = await getDocs(qUsers);
          users = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        }catch{
          const snap = await getDocs(query(collection(db, "users"), limit(60)));
          users = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        }

        if(!users.length){
          usersBox.textContent = "Nenhum usu√°rio encontrado.";
          return;
        }

        usersBox.style.display = "none";
        usersTableWrap.style.display = "block";
        renderSimpleTable(usersTableWrap, users, [
          { key:"name", label:"Nome", render: r => safeStr(r.name || "‚Äî") },
          { key:"email", label:"E-mail", render: r => safeStr(r.email || "‚Äî") },
          { key:"role", label:"Perfil", render: r => safeStr(r.role || "comunidade") },
          { key:"crgrIds", label:"CRGR", render: r => Array.isArray(r.crgrIds) && r.crgrIds.length ? r.crgrIds.join(", ") : "‚Äî" }
        ]);
      }catch(err){
        console.error(err);
        usersBox.textContent = "Erro ao carregar usu√°rios.";
      }
    }

    function wireNav(){
      document.querySelectorAll(".nav a[data-page]").forEach(a => {
        a.addEventListener("click", async (e) => {
          e.preventDefault();
          const key = a.getAttribute("data-page");
          showPage(key);

          // carregar dados b√°sicos conforme se√ß√£o
          if(key === "dashboard"){
            await loadKPIs();
            await loadDashboardTables();
          }
          if(key === "users"){
            await loadUsersPage();
          }
        });
      });

      document.querySelectorAll("[data-jump]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const key = btn.getAttribute("data-jump");
          showPage(key);
          const nav = document.querySelector(`.nav a[data-page="${key}"]`);
          if(nav) nav.classList.add("active");
          if(key === "users") await loadUsersPage();
        });
      });
    }

    async function loadAll(){
      await loadKPIs();
      await loadDashboardTables();
    }

    // Buttons
    backHomeBtn.addEventListener("click", () => window.location.href = "home.html");
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    document.getElementById("goHomeDenied")?.addEventListener("click", () => window.location.href = "home.html");
    document.getElementById("logoutDenied")?.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    refreshBtn.addEventListener("click", async () => {
      const active = document.querySelector(".section.active")?.id || "page-dashboard";
      await loadKPIs();
      if(active === "page-dashboard") await loadDashboardTables();
      if(active === "page-users") await loadUsersPage();
    });

    reloadUsersBtn.addEventListener("click", loadUsersPage);
    reloadPostsBtn.addEventListener("click", () => alert("Em seguida: implementar lista + criar/editar posts no admin."));
    reloadCrgrBtn.addEventListener("click", () => alert("Em seguida: implementar cadastro/edi√ß√£o de CRGR e dashboard por territ√≥rio."));

    // Auth + gate
    wireNav();

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "index.html";
        return;
      }
      sessionUser = user;

      // carrega perfil
      const uref = doc(db, "users", user.uid);
      const usnap = await getDoc(uref);
      sessionProfile = usnap.exists() ? usnap.data() : null;

      // gate admin
      if(!isAdmin(sessionProfile)){
        badgeStatus.textContent = "Sem permiss√£o";
        showPage("denied");
        return;
      }

      // profile header
      const name = sessionProfile?.name || user.displayName || (user.email ? user.email.split("@")[0] : "Admin");
      const role = sessionProfile?.role || "admin";

      adminName.textContent = name;
      adminRole.textContent = `Perfil: ${role}`;
      adminEmail.textContent = user.email || "‚Äî";
      setAvatar(user.photoURL || sessionProfile?.photoURL || null, initialsFrom(name));

      badgeStatus.textContent = "Admin";

      // default page
      showPage("dashboard");
      await loadAll();
    });

    // Global search (MVP: s√≥ navega por palavra-chave)
    globalSearch.addEventListener("input", () => {
      const q = safeStr(globalSearch.value).trim().toLowerCase();
      if(!q) return;

      // atalhos simples
      const map = [
        { key:"dashboard", terms:["painel","dashboard","vis√£o","geral","kpi"] },
        { key:"users", terms:["usu√°rio","usuarios","users","perfil","permiss"] },
        { key:"feed", terms:["feed","post","posts","publica","modera"] },
        { key:"territorios", terms:["crgr","territorio","territ√≥rios","cooperativa","unidade"] },
        { key:"planos", terms:["plano","planos","a√ß√£o","acoes"] },
        { key:"conteudos", terms:["conteudo","conte√∫dos","trilha","biblioteca","material"] }
      ];

      const hit = map.find(m => m.terms.some(t => q.includes(t)));
      if(hit){
        showPage(hit.key);
        if(hit.key === "users") loadUsersPage();
      }
    });
  </script>
</body>
</html>
