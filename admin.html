<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub Resili√™ncia Clim√°tica ‚Ä¢ Admin</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green-regen:#1B7F5A;
      --green-light:#4CAF8F;
      --blue-deep:#0D3B66;
      --yellow:#F2C94C;

      --graphite:#2E2E2E;
      --bg:#F5F7F6;
      --white:#FFFFFF;

      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --border:#E7ECEA;
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--graphite);
    }
    h1,h2,h3{ font-family:'Poppins', sans-serif; margin:0; }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea, select { font-family:inherit; }

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      padding:16px;
      max-width:1300px;
      margin:0 auto;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:16px;
      height: calc(100vh - 32px);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(13,59,102,0.98), rgba(27,127,90,0.98));
      box-shadow: var(--shadow);
      color:#fff;
      padding:14px;
      overflow:hidden;
    }
    .sidebar-title{
      padding:10px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.14);
      margin-bottom:12px;
    }
    .sidebar-title strong{ display:block; font-size:15px; letter-spacing:0.2px; }
    .sidebar-title span{ display:block; font-size:12.5px; opacity:.9; margin-top:4px; }

    .profile{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius:16px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
    }
    .avatar{
      width:56px; height:56px; border-radius:999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-family:'Poppins';
      letter-spacing:0.4px; flex:0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pmeta{ min-width:0; display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .pmeta strong{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pmeta .sub{ font-size:12px; opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .nav{ margin-top:12px; display:grid; gap:6px; }
    .nav button{
      cursor:pointer; color:#fff;
      padding:10px 12px; border-radius:14px;
      font-weight:900; font-size:13px;
      border: 1px solid transparent;
      opacity:.96;
      display:flex; align-items:center; gap:10px;
      background: transparent;
      text-align:left;
    }
    .nav button:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.12); }
    .nav .active{ background: rgba(242,201,76,0.14); border-color: rgba(242,201,76,0.28); }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 3px rgba(242,201,76,0.16);
      flex:0 0 auto;
    }

    .sidebar-bottom{
      position:absolute; left:14px; right:14px; bottom:12px;
      padding-top:10px; border-top:1px solid rgba(255,255,255,0.14);
      display:flex; flex-direction:column; gap:8px;
      font-size:12px; opacity:.9;
    }
    .logoutBtn{
      width:100%; border:none; cursor:pointer;
      border-radius:14px; padding:10px 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff; font-weight:900;
      display:flex; align-items:center; gap:10px;
      text-align:left;
    }
    .logoutBtn:hover{ background: rgba(255,255,255,0.14); }

    /* Content */
    .content{ display:flex; flex-direction:column; gap:12px; }

    .topbar{
      position:sticky; top:16px; z-index:5;
      background: rgba(245,247,246,0.82);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar h2{ font-size:16px; }
    .muted{ color:#666; font-size:13px; line-height:1.5; }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
    }
    .search input{
      border:none; outline:none;
      width:100%;
      font-size:14px;
    }

    .pillbtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      color:var(--blue-deep);
      cursor:pointer;
      white-space:nowrap;
    }
    .pillbtn:hover{ box-shadow: 0 10px 20px rgba(0,0,0,0.05); transform: translateY(-1px); }
    .pillbtn:active{ transform: translateY(0); opacity:.92; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .card-head{
      padding:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
    }
    .badge{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(76,175,143,0.12);
      color: var(--green-regen);
      border: 1px solid rgba(76,175,143,0.25);
      white-space:nowrap;
      font-weight:800;
      font-family:'Poppins';
    }
    .card-body{ padding:14px; }

    .field{
      display:grid;
      gap:6px;
      margin-top:10px;
    }
    .field label{
      font-size:12.5px;
      font-weight:900;
      color:#0d3b66;
      font-family:'Poppins';
    }
    .input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border: 1px solid var(--border);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .split{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .msg{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      line-height:1.35;
      border:1px solid var(--border);
      background:#fff;
      color:#2e2e2e;
    }
    .msg.show{ display:block; }
    .msg.error{
      background: rgba(242,201,76,0.18);
      border-color: rgba(242,201,76,0.34);
      color:#5b4a12;
    }
    .msg.success{
      background: rgba(76,175,143,0.14);
      border-color: rgba(76,175,143,0.28);
      color:#135a41;
    }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
    }
    .item:hover{ box-shadow: 0 10px 20px rgba(0,0,0,0.05); transform: translateY(-1px); }
    .item strong{ font-family:'Poppins'; font-size:13.5px; display:block; }
    .item span{ display:block; margin-top:4px; font-size:12.5px; color:#666; white-space:pre-wrap; }

    .tiny{ font-size:12px; color:#666; }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .tabhint{
      font-size:12px;
      color:#666;
      margin-top:8px;
      line-height:1.45;
    }
    .pilltag{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:#0d3b66;
      font-weight:900;
      font-family:'Poppins';
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .hidden{ display:none !important; }

    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .sidebar-bottom{ position:relative; left:0; right:0; bottom:0; margin-top:12px; }
      .grid{ grid-template-columns: 1fr; }
      .topbar{ top:12px; }
      .search{ order:3; width:100%; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-title" translate="no">
        <strong>Hub Resili√™ncia Clim√°tica</strong>
        <span>Painel do Administrador</span>
      </div>

      <div class="profile" translate="no">
        <div class="avatar" id="avatarBox">AD</div>
        <div class="pmeta">
          <strong id="userName">Carregando...</strong>
          <div class="sub" id="userRole">Perfil: ‚Äî</div>
          <div class="sub" id="userEmail">‚Äî</div>
        </div>
      </div>

      <nav class="nav" id="navMenu" aria-label="Menu admin" translate="no">
        <button class="active" data-view="usersView"><span class="dot"></span> Usu√°rios</button>
        <button data-view="feedView"><span class="dot"></span> Feed (Posts)</button>
        <button data-view="crgrView"><span class="dot"></span> CRGR / Territ√≥rios</button>
        <a href="home.html" style="margin-top:8px; display:block; padding:10px 12px; border-radius:14px; background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.14); font-weight:900;">
          ‚Üê Voltar ao Feed
        </a>
      </nav>

      <div class="sidebar-bottom">
        <button id="logoutBtn" class="logoutBtn" translate="no">
          <span class="dot"></span> Sair
        </button>
        <div translate="no">Plataforma Regenera ‚Ä¢ v0.1</div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar" translate="no">
        <div style="min-width:240px;">
          <h2 id="viewTitle">Usu√°rios</h2>
          <div class="muted" id="viewSubtitle">Gerencie perfis, fun√ß√µes e permiss√µes.</div>
        </div>

        <div class="search" aria-label="Pesquisar">
          <span style="opacity:.65;">üîé</span>
          <input id="searchInput" placeholder="Pesquisar..." />
        </div>

        <button class="pillbtn" id="reloadBtn" type="button">Recarregar</button>
      </div>

      <div id="msgBox" class="msg"></div>

      <!-- ===== VIEW: USERS ===== -->
      <section id="usersView">
        <div class="card">
          <div class="card-head">
            <div>
              <h3 style="font-size:14px;">Lista de usu√°rios</h3>
              <div class="tabs" style="margin-top:8px;">
                <span class="pilltag" id="usersCount">0 usu√°rios</span>
                <span class="pilltag">Clique em um usu√°rio para editar</span>
              </div>
            </div>
            <div class="badge">USERS</div>
          </div>
          <div class="card-body">
            <div class="grid">
              <div>
                <div class="tabs" style="margin-top:0;">
                  <button class="pillbtn" type="button" data-rolefilter="all">Todos</button>
                  <button class="pillbtn" type="button" data-rolefilter="comunidade">Comunidade</button>
                  <button class="pillbtn" type="button" data-rolefilter="lideranca">Lideran√ßa</button>
                  <button class="pillbtn" type="button" data-rolefilter="tecnico">T√©cnico</button>
                  <button class="pillbtn" type="button" data-rolefilter="gestor">Gestor</button>
                  <button class="pillbtn" type="button" data-rolefilter="admin">Admin</button>
                </div>

                <div class="tabhint">
                  Filtragem √© no cliente (sem √≠ndices). A lista √© carregada de <code>users</code>.
                </div>

                <div id="usersList" class="list" style="margin-top:12px;"></div>
                <div id="usersEmpty" class="msg show">Carregando...</div>
              </div>

              <div class="card" style="box-shadow:none;">
                <div class="card-head">
                  <div>
                    <h3 style="font-size:14px;">Editar usu√°rio</h3>
                    <div class="muted" style="margin-top:4px;">Salva em <code>users/{uid}</code></div>
                  </div>
                  <div class="badge">EDIT</div>
                </div>
                <div class="card-body">
                  <div class="tiny">UID</div>
                  <div class="pilltag" id="editUid">‚Äî</div>

                  <div class="field">
                    <label for="editName">Nome</label>
                    <input class="input" id="editName" placeholder="Nome do usu√°rio" />
                  </div>

                  <div class="field">
                    <label for="editBio">Mini bio</label>
                    <textarea id="editBio" placeholder="Descreva a atua√ß√£o..."></textarea>
                  </div>

                  <div class="field">
                    <label for="editRole">Fun√ß√£o (role)</label>
                    <select id="editRole">
                      <option value="comunidade">comunidade</option>
                      <option value="lideranca">lideranca</option>
                      <option value="tecnico">tecnico</option>
                      <option value="gestor">gestor</option>
                      <option value="admin">admin</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="editCrgrIds">CRGR IDs (separados por v√≠rgula)</label>
                    <input class="input" id="editCrgrIds" placeholder="Ex.: vila-pinto-poa, crgr-centro" />
                  </div>

                  <div class="field">
                    <label for="editModules">M√≥dulos (JSON simples)</label>
                    <textarea id="editModules" placeholder='Ex.: {"feed":true,"territorio":true,"admin":false}'></textarea>
                    <div class="tiny">Se estiver vazio, a plataforma usa defaults (feed=true).</div>
                  </div>

                  <div class="split">
                    <button class="pillbtn" id="saveUserBtn" type="button">Salvar altera√ß√µes</button>
                  </div>

                  <div class="tabhint">
                    Dica: para liberar admin, defina <b>role=admin</b> ou <b>modules.admin=true</b>.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== VIEW: FEED ===== -->
      <section id="feedView" class="hidden">
        <div class="grid">
          <section class="card">
            <div class="card-head">
              <div>
                <h3 style="font-size:14px;">Criar publica√ß√£o</h3>
                <div class="muted" style="margin-top:4px;">Somente admin cria/edita posts</div>
              </div>
              <div class="badge">POST</div>
            </div>
            <div class="card-body">
              <div class="field">
                <label for="postText">Texto</label>
                <textarea id="postText" placeholder="Escreva a publica√ß√£o..."></textarea>
              </div>

              <div class="field">
                <label for="postTags">Tags (separadas por v√≠rgula)</label>
                <input class="input" id="postTags" placeholder="Ex.: reciclagem, oficina, crgr" />
              </div>

              <div class="split">
                <button class="pillbtn" id="createPostBtn" type="button">Publicar</button>
              </div>

              <div class="tabhint">
                Posts ficam em <code>posts</code>. Todos logados leem, admin escreve.
              </div>
            </div>
          </section>

          <section class="card">
            <div class="card-head">
              <div>
                <h3 style="font-size:14px;">Publica√ß√µes</h3>
                <div class="muted" style="margin-top:4px;">Clique para selecionar/editar</div>
              </div>
              <div class="badge" id="postsCount">0</div>
            </div>
            <div class="card-body">
              <div id="postsList" class="list"></div>
              <div id="postsEmpty" class="msg show">Carregando...</div>

              <div class="card" style="margin-top:12px; box-shadow:none;">
                <div class="card-head">
                  <div>
                    <h3 style="font-size:14px;">Editar post</h3>
                    <div class="muted" style="margin-top:4px;">Salva em <code>posts/{postId}</code></div>
                  </div>
                  <div class="badge">EDIT</div>
                </div>
                <div class="card-body">
                  <div class="tiny">Post ID</div>
                  <div class="pilltag" id="editPostId">‚Äî</div>

                  <div class="field">
                    <label for="editPostText">Texto</label>
                    <textarea id="editPostText"></textarea>
                  </div>

                  <div class="field">
                    <label for="editPostTags">Tags (v√≠rgula)</label>
                    <input class="input" id="editPostTags" />
                  </div>

                  <div class="split">
                    <button class="pillbtn" id="savePostBtn" type="button">Salvar</button>
                    <button class="pillbtn" id="deletePostBtn" type="button">Excluir</button>
                  </div>
                </div>
              </div>

            </div>
          </section>
        </div>
      </section>

      <!-- ===== VIEW: CRGR ===== -->
      <section id="crgrView" class="hidden">
        <div class="grid">
          <section class="card">
            <div class="card-head">
              <div>
                <h3 style="font-size:14px;">Cadastro de Unidade (CRGR)</h3>
                <div class="muted" style="margin-top:4px;">Salva em <code>crgrs/{crgrId}</code></div>
              </div>
              <div class="badge">CRGR</div>
            </div>

            <div class="card-body">
              <div class="field">
                <label for="crgrId">ID (slug)</label>
                <input class="input" id="crgrId" placeholder="Ex.: vila-pinto-poa" />
              </div>

              <div class="field">
                <label for="crgrName">Nome</label>
                <input class="input" id="crgrName" placeholder="Ex.: CRGR Vila Pinto" />
              </div>

              <div class="field">
                <label for="territoryName">Territ√≥rio</label>
                <input class="input" id="territoryName" placeholder="Ex.: Zona Leste ‚Ä¢ Bom Jesus" />
              </div>

              <div class="field">
                <label for="city">Cidade</label>
                <input class="input" id="city" placeholder="Ex.: Porto Alegre" />
              </div>

              <div class="field">
                <label for="state">UF</label>
                <input class="input" id="state" placeholder="Ex.: RS" maxlength="2" />
              </div>

              <div class="field">
                <label for="desc">Descri√ß√£o</label>
                <textarea id="desc" placeholder="Resumo do CRGR, atua√ß√£o, etc."></textarea>
              </div>

              <div class="split">
                <button class="pillbtn" id="saveCrgrBtn" type="button">Salvar CRGR</button>
                <button class="pillbtn" id="loadCrgrBtn" type="button">Carregar por ID</button>
              </div>
            </div>
          </section>

          <section class="card">
            <div class="card-head">
              <div>
                <h3 style="font-size:14px;">Vincular membros</h3>
                <div class="muted" style="margin-top:4px;">Atualiza CRGR e usu√°rio</div>
              </div>
              <div class="badge">Acesso</div>
            </div>

            <div class="card-body">
              <div class="field">
                <label for="memberUid">UID do usu√°rio</label>
                <input class="input" id="memberUid" placeholder="Cole o UID" />
              </div>

              <div class="split">
                <button class="pillbtn" id="addMemberBtn" type="button">Adicionar</button>
                <button class="pillbtn" id="removeMemberBtn" type="button">Remover</button>
              </div>

              <div class="field" style="margin-top:14px;">
                <label>Membros do CRGR carregado</label>
                <div id="membersList" class="list"></div>
                <div id="membersEmpty" class="tiny">Carregue um CRGR para ver a lista.</div>
              </div>
            </div>
          </section>
        </div>

        <section class="card">
          <div class="card-head">
            <div>
              <h3 style="font-size:14px;">Unidades cadastradas</h3>
              <div class="muted" style="margin-top:4px;">Lista de <code>crgrs</code> (MVP)</div>
            </div>
            <div class="badge" id="crgrCount">0</div>
          </div>
          <div class="card-body">
            <div id="crgrList" class="list"></div>
            <div id="crgrEmpty" class="msg show">Carregando...</div>
          </div>
        </section>
      </section>

    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      getDocs,
      addDoc,
      deleteDoc,
      serverTimestamp,
      arrayUnion,
      arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8LPTZD7LA_CW2fOnJXJlVe6pByLyrRzo",
      authDomain: "hub-resiliencia-climatica.firebaseapp.com",
      projectId: "hub-resiliencia-climatica",
      storageBucket: "hub-resiliencia-climatica.firebasestorage.app",
      messagingSenderId: "485694309026",
      appId: "1:485694309026:web:771ed497d49861fa444dfb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== UI (sidebar profile)
    const avatarBox = document.getElementById("avatarBox");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const userEmailEl = document.getElementById("userEmail");
    const msgBox = document.getElementById("msgBox");

    // ===== Topbar
    const viewTitle = document.getElementById("viewTitle");
    const viewSubtitle = document.getElementById("viewSubtitle");
    const searchInput = document.getElementById("searchInput");
    const reloadBtn = document.getElementById("reloadBtn");

    // ===== Views
    const usersView = document.getElementById("usersView");
    const feedView = document.getElementById("feedView");
    const crgrView = document.getElementById("crgrView");

    // ===== Users
    const usersList = document.getElementById("usersList");
    const usersEmpty = document.getElementById("usersEmpty");
    const usersCount = document.getElementById("usersCount");

    const editUid = document.getElementById("editUid");
    const editName = document.getElementById("editName");
    const editBio = document.getElementById("editBio");
    const editRole = document.getElementById("editRole");
    const editCrgrIds = document.getElementById("editCrgrIds");
    const editModules = document.getElementById("editModules");
    const saveUserBtn = document.getElementById("saveUserBtn");

    // ===== Feed
    const postText = document.getElementById("postText");
    const postTags = document.getElementById("postTags");
    const createPostBtn = document.getElementById("createPostBtn");
    const postsList = document.getElementById("postsList");
    const postsEmpty = document.getElementById("postsEmpty");
    const postsCount = document.getElementById("postsCount");
    const editPostId = document.getElementById("editPostId");
    const editPostText = document.getElementById("editPostText");
    const editPostTags = document.getElementById("editPostTags");
    const savePostBtn = document.getElementById("savePostBtn");
    const deletePostBtn = document.getElementById("deletePostBtn");

    // ===== CRGR
    const crgrIdEl = document.getElementById("crgrId");
    const crgrNameEl = document.getElementById("crgrName");
    const territoryNameEl = document.getElementById("territoryName");
    const cityEl = document.getElementById("city");
    const stateEl = document.getElementById("state");
    const descEl = document.getElementById("desc");
    const saveCrgrBtn = document.getElementById("saveCrgrBtn");
    const loadCrgrBtn = document.getElementById("loadCrgrBtn");

    const memberUidEl = document.getElementById("memberUid");
    const addMemberBtn = document.getElementById("addMemberBtn");
    const removeMemberBtn = document.getElementById("removeMemberBtn");
    const membersList = document.getElementById("membersList");
    const membersEmpty = document.getElementById("membersEmpty");

    const crgrList = document.getElementById("crgrList");
    const crgrEmpty = document.getElementById("crgrEmpty");
    const crgrCount = document.getElementById("crgrCount");

    // ===== State
    let sessionUser = null;
    let sessionProfile = null;

    let usersCache = [];
    let postsCache = [];
    let loadedUser = null;

    let loadedPost = null;
    let loadedCrgr = null;

    let roleFilter = "all";
    let activeView = "usersView";

    // ===== Helpers
    function safeStr(v){ return (v ?? "").toString(); }

    function showMsg(type, text){
      msgBox.className = "msg show " + (type === "error" ? "error" : "success");
      msgBox.textContent = text;
      setTimeout(() => {
        msgBox.className = "msg";
        msgBox.textContent = "";
      }, 4200);
    }

    function initialsFrom(str){
      const s = (str || "").trim();
      if(!s) return "AD";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function setAvatar(photoURL, fallback){
      avatarBox.innerHTML = "";
      if(photoURL){
        const img = document.createElement("img");
        img.src = photoURL;
        img.alt = "Avatar";
        avatarBox.appendChild(img);
      }else{
        avatarBox.textContent = fallback;
      }
    }

    function isAdminProfile(p){
      if(!p) return false;
      const modules = p.modules || {};
      return p.role === "admin" || modules.admin === true;
    }

    function slugify(s){
      return safeStr(s)
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "")
        .slice(0, 64);
    }

    function setView(viewId){
      activeView = viewId;
      usersView.classList.toggle("hidden", viewId !== "usersView");
      feedView.classList.toggle("hidden", viewId !== "feedView");
      crgrView.classList.toggle("hidden", viewId !== "crgrView");

      // nav active state
      document.querySelectorAll(".nav button[data-view]").forEach(b => {
        b.classList.toggle("active", b.dataset.view === viewId);
      });

      // title/subtitle
      if(viewId === "usersView"){
        viewTitle.textContent = "Usu√°rios";
        viewSubtitle.textContent = "Gerencie perfis, fun√ß√µes e permiss√µes.";
        searchInput.placeholder = "Pesquisar usu√°rios...";
      }
      if(viewId === "feedView"){
        viewTitle.textContent = "Feed (Posts)";
        viewSubtitle.textContent = "Publica√ß√µes do projeto (admin publica, todos leem).";
        searchInput.placeholder = "Pesquisar posts...";
      }
      if(viewId === "crgrView"){
        viewTitle.textContent = "CRGR / Territ√≥rios";
        viewSubtitle.textContent = "Cadastre unidades, edite dados e vincule membros.";
        searchInput.placeholder = "Pesquisar CRGR...";
      }

      // refresh on view
      refreshCurrentView();
    }

    function refreshCurrentView(){
      const q = safeStr(searchInput.value).trim().toLowerCase();

      if(activeView === "usersView"){
        renderUsersList(filterUsers(usersCache, q));
      }
      if(activeView === "feedView"){
        renderPostsList(filterPosts(postsCache, q));
      }
      if(activeView === "crgrView"){
        renderCrgrList(filterCrgr(crgrCache, q));
      }
    }

    // ===== USERS
    function filterUsers(arr, q){
      let out = arr;
      if(roleFilter !== "all"){
        out = out.filter(u => (u.role || "comunidade") === roleFilter);
      }
      if(!q) return out;
      return out.filter(u => {
        const hay = [
          u.uid, u.email, u.name, u.role,
          JSON.stringify(u.modules || {}),
          Array.isArray(u.crgrIds) ? u.crgrIds.join(" ") : ""
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function renderUsersList(arr){
      usersList.innerHTML = "";
      usersEmpty.style.display = "none";
      usersCount.textContent = `${arr.length} usu√°rios`;

      if(!arr.length){
        usersEmpty.className = "msg show";
        usersEmpty.textContent = "Nenhum usu√°rio encontrado.";
        usersEmpty.style.display = "block";
        return;
      }

      arr.forEach(u => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <strong>${safeStr(u.name || u.email || "Usu√°rio")}</strong>
          <span><b>Role:</b> ${safeStr(u.role || "comunidade")} ‚Ä¢ <b>E-mail:</b> ${safeStr(u.email || "‚Äî")}
          <br/><b>UID:</b> ${safeStr(u.uid)}
          <br/><b>CRGR:</b> ${Array.isArray(u.crgrIds) && u.crgrIds.length ? u.crgrIds.join(", ") : "‚Äî"}
          </span>
        `;
        div.addEventListener("click", () => selectUser(u.uid));
        usersList.appendChild(div);
      });
    }

    async function loadUsers(){
      usersEmpty.className = "msg show";
      usersEmpty.textContent = "Carregando...";
      usersEmpty.style.display = "block";

      const snap = await getDocs(collection(db, "users"));
      usersCache = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
      // sort by name/email
      usersCache.sort((a,b) => safeStr(a.name || a.email).localeCompare(safeStr(b.name || b.email), "pt-BR"));

      usersEmpty.style.display = "none";
      renderUsersList(filterUsers(usersCache, safeStr(searchInput.value).trim().toLowerCase()));
    }

    function selectUser(uid){
      const u = usersCache.find(x => x.uid === uid);
      if(!u) return;

      loadedUser = u;
      editUid.textContent = u.uid;
      editName.value = safeStr(u.name || "");
      editBio.value = safeStr(u.bio || "");
      editRole.value = safeStr(u.role || "comunidade");

      const crgrIds = Array.isArray(u.crgrIds) ? u.crgrIds : [];
      editCrgrIds.value = crgrIds.join(", ");

      // modules
      const modules = u.modules || {};
      editModules.value = Object.keys(modules).length ? JSON.stringify(modules) : "";
    }

    async function saveUser(){
      if(!loadedUser) return showMsg("error", "Selecione um usu√°rio na lista.");
      const uid = loadedUser.uid;

      // parse crgrIds
      const crgrIds = safeStr(editCrgrIds.value)
        .split(",")
        .map(s => slugify(s))
        .filter(Boolean);

      // parse modules JSON (optional)
      let modulesObj = null;
      const modulesText = safeStr(editModules.value).trim();
      if(modulesText){
        try{
          const parsed = JSON.parse(modulesText);
          if(parsed && typeof parsed === "object"){
            modulesObj = parsed;
          }
        }catch{
          return showMsg("error", "M√≥dulos inv√°lidos. Use JSON v√°lido (ex.: {\"feed\":true}).");
        }
      }

      const patch = {
        name: safeStr(editName.value).trim() || null,
        bio: safeStr(editBio.value).trim() || null,
        role: safeStr(editRole.value).trim() || "comunidade",
        crgrIds,
        updatedAt: serverTimestamp()
      };
      if(modulesObj) patch.modules = modulesObj;

      await setDoc(doc(db, "users", uid), patch, { merge:true });

      showMsg("success", "Usu√°rio atualizado!");
      await loadUsers();
      selectUser(uid);
    }

    // role filter buttons
    document.querySelectorAll("[data-rolefilter]").forEach(btn => {
      btn.addEventListener("click", () => {
        roleFilter = btn.dataset.rolefilter;
        renderUsersList(filterUsers(usersCache, safeStr(searchInput.value).trim().toLowerCase()));
      });
    });

    saveUserBtn.addEventListener("click", saveUser);

    // ===== FEED (POSTS)
    function filterPosts(arr, q){
      if(!q) return arr;
      return arr.filter(p => {
        const hay = [
          p.id, p.text, p.authorName, p.authorRole,
          Array.isArray(p.tags) ? p.tags.join(" ") : ""
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function renderPostsList(arr){
      postsList.innerHTML = "";
      postsEmpty.style.display = "none";
      postsCount.textContent = String(arr.length);

      if(!arr.length){
        postsEmpty.className = "msg show";
        postsEmpty.textContent = "Nenhum post encontrado.";
        postsEmpty.style.display = "block";
        return;
      }

      arr.forEach(p => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <strong>${safeStr(p.text || "").slice(0, 60) || "Post"}</strong>
          <span>
            <b>Autor:</b> ${safeStr(p.authorName || "Admin")} ‚Ä¢ <b>Tags:</b> ${Array.isArray(p.tags) ? p.tags.join(", ") : "‚Äî"}
            <br/><b>ID:</b> ${p.id}
          </span>
        `;
        div.addEventListener("click", () => selectPost(p.id));
        postsList.appendChild(div);
      });
    }

    async function loadPosts(){
      postsEmpty.className = "msg show";
      postsEmpty.textContent = "Carregando...";
      postsEmpty.style.display = "block";

      const snap = await getDocs(collection(db, "posts"));
      postsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      // sort client-side by createdAt
      postsCache.sort((a,b) => {
        const at = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const bt = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return bt - at;
      });

      postsEmpty.style.display = "none";
      renderPostsList(filterPosts(postsCache, safeStr(searchInput.value).trim().toLowerCase()));
    }

    function selectPost(id){
      const p = postsCache.find(x => x.id === id);
      if(!p) return;

      loadedPost = p;
      editPostId.textContent = p.id;
      editPostText.value = safeStr(p.text || "");
      editPostTags.value = Array.isArray(p.tags) ? p.tags.join(", ") : "";
    }

    async function createPost(){
      const text = safeStr(postText.value).trim();
      if(!text) return showMsg("error", "Escreva um texto para o post.");

      const tags = safeStr(postTags.value)
        .split(",")
        .map(s => safeStr(s).trim())
        .filter(Boolean)
        .slice(0, 12);

      const authorName = sessionProfile?.name || sessionUser?.displayName || (sessionUser?.email ? sessionUser.email.split("@")[0] : "Admin");
      const authorRole = sessionProfile?.role || "admin";

      await addDoc(collection(db, "posts"), {
        text,
        tags,
        scope: { type: "all" }, // deixa padr√£o
        authorUid: sessionUser.uid,
        authorName,
        authorRole,
        authorPhotoURL: sessionUser.photoURL || sessionProfile?.photoURL || null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      postText.value = "";
      postTags.value = "";
      showMsg("success", "Post publicado!");
      await loadPosts();
    }

    async function savePost(){
      if(!loadedPost) return showMsg("error", "Selecione um post.");
      const text = safeStr(editPostText.value).trim();
      const tags = safeStr(editPostTags.value)
        .split(",")
        .map(s => safeStr(s).trim())
        .filter(Boolean)
        .slice(0, 12);

      await setDoc(doc(db, "posts", loadedPost.id), {
        text,
        tags,
        updatedAt: serverTimestamp()
      }, { merge:true });

      showMsg("success", "Post atualizado!");
      await loadPosts();
      selectPost(loadedPost.id);
    }

    async function deletePostNow(){
      if(!loadedPost) return showMsg("error", "Selecione um post.");
      await deleteDoc(doc(db, "posts", loadedPost.id));
      showMsg("success", "Post exclu√≠do!");
      loadedPost = null;
      editPostId.textContent = "‚Äî";
      editPostText.value = "";
      editPostTags.value = "";
      await loadPosts();
    }

    createPostBtn.addEventListener("click", createPost);
    savePostBtn.addEventListener("click", savePost);
    deletePostBtn.addEventListener("click", deletePostNow);

    // ===== CRGR
    let crgrCache = [];

    function filterCrgr(arr, q){
      if(!q) return arr;
      return arr.filter(c => {
        const hay = [c.id, c.name, c.city, c.state, c.territoryName, c.description].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function renderCrgrList(arr){
      crgrList.innerHTML = "";
      crgrEmpty.style.display = "none";
      crgrCount.textContent = String(arr.length);

      if(!arr.length){
        crgrEmpty.className = "msg show";
        crgrEmpty.textContent = "Nenhum CRGR encontrado.";
        crgrEmpty.style.display = "block";
        return;
      }

      arr.forEach(c => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <strong>${safeStr(c.name || c.id)}</strong>
          <span><b>ID:</b> ${c.id} ‚Ä¢ ${safeStr(c.city || "‚Äî")}/${safeStr(c.state || "‚Äî")} ‚Ä¢ <b>Territ√≥rio:</b> ${safeStr(c.territoryName || "‚Äî")}</span>
        `;
        div.addEventListener("click", () => loadCrgrById(c.id));
        crgrList.appendChild(div);
      });
    }

    function renderMembers(){
      membersList.innerHTML = "";
      const arr = Array.isArray(loadedCrgr?.memberUids) ? loadedCrgr.memberUids : [];
      if(!loadedCrgr){
        membersEmpty.style.display = "block";
        return;
      }
      membersEmpty.style.display = arr.length ? "none" : "block";
      arr.forEach(uid => {
        const div = document.createElement("div");
        div.className = "item";
        div.style.cursor = "default";
        div.innerHTML = `<strong>${uid}</strong><span>UID vinculado ao CRGR</span>`;
        membersList.appendChild(div);
      });
    }

    async function loadCrgrList(){
      crgrEmpty.className = "msg show";
      crgrEmpty.textContent = "Carregando...";
      crgrEmpty.style.display = "block";

      const snap = await getDocs(collection(db, "crgrs"));
      crgrCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      crgrCache.sort((a,b) => safeStr(a.name || a.id).localeCompare(safeStr(b.name || b.id), "pt-BR"));

      crgrEmpty.style.display = "none";
      renderCrgrList(filterCrgr(crgrCache, safeStr(searchInput.value).trim().toLowerCase()));
    }

    async function loadCrgrById(id){
      const ref = doc(db, "crgrs", id);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        loadedCrgr = null;
        renderMembers();
        return showMsg("error", "CRGR n√£o encontrado.");
      }
      loadedCrgr = { id: snap.id, ...snap.data() };

      crgrIdEl.value = loadedCrgr.id;
      crgrNameEl.value = safeStr(loadedCrgr.name || "");
      territoryNameEl.value = safeStr(loadedCrgr.territoryName || "");
      cityEl.value = safeStr(loadedCrgr.city || "");
      stateEl.value = safeStr(loadedCrgr.state || "");
      descEl.value = safeStr(loadedCrgr.description || "");

      renderMembers();
      showMsg("success", "CRGR carregado.");
    }

    async function saveCrgr(){
      let id = slugify(crgrIdEl.value);
      if(!id) id = slugify(crgrNameEl.value);
      if(!id) return showMsg("error", "Informe o ID ou o nome do CRGR.");

      const data = {
        name: safeStr(crgrNameEl.value).trim() || id,
        territoryName: safeStr(territoryNameEl.value).trim() || null,
        city: safeStr(cityEl.value).trim() || null,
        state: safeStr(stateEl.value).trim().toUpperCase() || null,
        description: safeStr(descEl.value).trim() || null,
        isActive: true,
        updatedAt: serverTimestamp()
      };

      const ref = doc(db, "crgrs", id);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        await setDoc(ref, {
          ...data,
          memberUids: [],
          managersUids: [],
          techniciansUids: [],
          createdAt: serverTimestamp()
        });
        showMsg("success", "CRGR criado!");
      }else{
        await setDoc(ref, data, { merge:true });
        showMsg("success", "CRGR atualizado!");
      }

      await loadCrgrById(id);
      await loadCrgrList();
    }

    async function addMember(){
      if(!loadedCrgr) return showMsg("error", "Carregue um CRGR primeiro.");
      const uid = safeStr(memberUidEl.value).trim();
      if(!uid) return showMsg("error", "Informe o UID do usu√°rio.");

      await updateDoc(doc(db, "crgrs", loadedCrgr.id), {
        memberUids: arrayUnion(uid),
        updatedAt: serverTimestamp()
      });

      // adiciona no user tamb√©m
      const uref = doc(db, "users", uid);
      const usnap = await getDoc(uref);
      if(usnap.exists()){
        await updateDoc(uref, {
          crgrIds: arrayUnion(loadedCrgr.id),
          updatedAt: serverTimestamp()
        });
      }

      await loadCrgrById(loadedCrgr.id);
      showMsg("success", "Membro vinculado!");
    }

    async function removeMember(){
      if(!loadedCrgr) return showMsg("error", "Carregue um CRGR primeiro.");
      const uid = safeStr(memberUidEl.value).trim();
      if(!uid) return showMsg("error", "Informe o UID do usu√°rio.");

      await updateDoc(doc(db, "crgrs", loadedCrgr.id), {
        memberUids: arrayRemove(uid),
        updatedAt: serverTimestamp()
      });

      // remove do user tamb√©m
      const uref = doc(db, "users", uid);
      const usnap = await getDoc(uref);
      if(usnap.exists()){
        await updateDoc(uref, {
          crgrIds: arrayRemove(loadedCrgr.id),
          updatedAt: serverTimestamp()
        });
      }

      await loadCrgrById(loadedCrgr.id);
      showMsg("success", "Membro removido!");
    }

    saveCrgrBtn.addEventListener("click", saveCrgr);
    loadCrgrBtn.addEventListener("click", () => {
      const id = slugify(crgrIdEl.value);
      if(!id) return showMsg("error", "Informe um ID v√°lido.");
      loadCrgrById(id);
    });
    addMemberBtn.addEventListener("click", addMember);
    removeMemberBtn.addEventListener("click", removeMember);

    // ===== Nav view switching
    document.querySelectorAll(".nav button[data-view]").forEach(btn => {
      btn.addEventListener("click", () => setView(btn.dataset.view));
    });

    // ===== Search + Reload
    searchInput.addEventListener("input", () => refreshCurrentView());

    reloadBtn.addEventListener("click", async () => {
      try{
        if(activeView === "usersView") await loadUsers();
        if(activeView === "feedView") await loadPosts();
        if(activeView === "crgrView") await loadCrgrList();
        showMsg("success", "Atualizado.");
      }catch(err){
        console.error(err);
        showMsg("error", "Erro ao recarregar. Verifique permiss√µes.");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // ===== Auth gate
    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "index.html";
        return;
      }
      sessionUser = user;

      const uref = doc(db, "users", user.uid);
      const usnap = await getDoc(uref);
      if(!usnap.exists()){
        window.location.href = "home.html";
        return;
      }
      sessionProfile = usnap.data();

      const name = sessionProfile.name || user.displayName || (user.email ? user.email.split("@")[0] : "Admin");
      const role = sessionProfile.role || "‚Äî";

      userNameEl.textContent = name;
      userRoleEl.textContent = `Perfil: ${role}`;
      userEmailEl.textContent = user.email || "‚Äî";
      setAvatar(user.photoURL || sessionProfile.photoURL || null, initialsFrom(name));

      if(!isAdminProfile(sessionProfile)){
        showMsg("error", "Acesso negado. Voc√™ n√£o √© admin.");
        setTimeout(() => window.location.href = "home.html", 1200);
        return;
      }

      // defaults: garante admin module true (opcional)
      // await setDoc(uref, { modules: { ...(sessionProfile.modules||{}), admin:true } }, { merge:true });

      // init
      await loadUsers();
      await loadPosts();
      await loadCrgrList();

      // prefill CRGR exemplo
      if(!crgrIdEl.value){
        crgrIdEl.value = "vila-pinto-poa";
        crgrNameEl.value = "CRGR Vila Pinto";
        territoryNameEl.value = "Zona Leste ‚Ä¢ Bom Jesus";
        cityEl.value = "Porto Alegre";
        stateEl.value = "RS";
        descEl.value = "Unidade/territ√≥rio de refer√™ncia em reciclagem e educa√ß√£o ambiental.";
      }
    });
  </script>
</body>
</html>
