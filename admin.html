<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub Resili√™ncia Clim√°tica ‚Ä¢ Governan√ßa (Admin)</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green-regen:#1B7F5A;
      --green-light:#4CAF8F;
      --blue-deep:#0D3B66;
      --yellow:#F2C94C;

      --graphite:#2E2E2E;
      --bg:#F5F7F6;
      --white:#FFFFFF;

      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --border:#E7ECEA;
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--graphite);
    }
    h1,h2,h3{
      font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0;
    }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea, select { font-family:inherit; }
    .muted{ color:#666; font-size:13px; line-height:1.5; }

    /* Layout */
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 310px 1fr;
      gap:16px;
      padding:16px;
      max-width:1280px;
      margin:0 auto;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:16px;
      height: calc(100vh - 32px);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(13,59,102,0.98), rgba(27,127,90,0.98));
      box-shadow: var(--shadow);
      color:#fff;
      padding:14px;
      overflow:hidden;
      isolation:isolate;
    }
    .sidebar::before{
      content:"";
      position:absolute;
      inset:-120px -120px auto auto;
      width:380px;
      height:380px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(242,201,76,0.22), rgba(255,255,255,0) 62%);
      pointer-events:none;
      z-index:0;
    }
    .sidebar > *{ position:relative; z-index:1; }

    .sidebar-title{
      padding:10px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.14);
      margin-bottom:12px;
    }
    .sidebar-title strong{ display:block; font-size:15px; letter-spacing:0.2px; }
    .sidebar-title span{ display:block; font-size:12.5px; opacity:.9; margin-top:4px; }

    .profile{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
      margin-bottom:10px;
    }
    .avatar{
      width:54px; height:54px;
      border-radius:999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-family:'Poppins';
      letter-spacing:0.4px;
      flex:0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pmeta{ min-width:0; display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .pmeta strong{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pmeta .sub{ font-size:12px; opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .bio{
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,0.10);
      border: 1px dashed rgba(255,255,255,0.20);
      font-size:12.5px;
      line-height:1.45;
      opacity:.95;
    }

    .nav{
      margin-top:12px;
      display:grid;
      gap:6px;
    }
    .nav a{
      cursor:pointer;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      text-align:left;
      border: 1px solid transparent;
      opacity:.96;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .nav a:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.12); }
    .nav a.active{ background: rgba(242,201,76,0.14); border-color: rgba(242,201,76,0.28); }

    .dot{
      width:8px; height:8px;
      border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 3px rgba(242,201,76,0.16);
      flex:0 0 auto;
    }

    .sidebar-bottom{
      position:absolute;
      left:14px;
      right:14px;
      bottom:12px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.14);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      opacity:.92;
    }
    .btn-ghost{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:left;
    }
    .btn-ghost:hover{ background: rgba(255,255,255,0.14); }

    /* Content */
    .content{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }

    .topbar{
      position:sticky;
      top:16px;
      z-index:10;
      background: rgba(245,247,246,0.86);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .top-left{ min-width:240px; }
    .topbar h2{ font-size:16px; }
    .top-sub{ margin-top:2px; }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
      min-width:180px;
    }
    .search input{
      border:none;
      outline:none;
      width:100%;
      font-size:14px;
      background:transparent;
    }

    .pillbtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      color:var(--blue-deep);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pillbtn:hover{
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      transform: translateY(-1px);
    }
    .pillbtn:active{ transform: translateY(0); opacity:.92; }
    .pillbtn.primary{
      color:#fff;
      border-color: rgba(27,127,90,0.22);
      background: linear-gradient(135deg, var(--green-light), var(--green-regen));
      box-shadow: 0 12px 24px rgba(27,127,90,0.18);
    }

    .panel{
      border:1px solid var(--border);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      padding:14px;
      min-width:0;
    }

    .grid{
      display:grid;
      gap:12px;
    }
    .grid.cols-4{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .grid.cols-2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0, 1fr)); }

    .kpi{
      border:1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, #fff, #fbfcfb);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:96px;
    }
    .kpi strong{
      font-family:'Poppins';
      font-size:13px;
      color:#0d3b66;
    }
    .kpi .num{
      font-family:'Poppins';
      font-size:28px;
      letter-spacing:-0.02em;
    }
    .kpi .hint{
      font-size:12.5px;
      color:#666;
      margin-top:auto;
    }

    .section-title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .section-title h3{ font-size:14px; }
    .badge{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(76,175,143,0.12);
      color: var(--green-regen);
      border: 1px solid rgba(76,175,143,0.25);
      white-space:nowrap;
      font-weight:700;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      color:#0d3b66;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .tab.active{
      background: rgba(13,59,102,0.08);
      border-color: rgba(13,59,102,0.18);
    }

    /* Lists / rows */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .rowcard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      background:#fff;
      min-width:0;
    }
    .mini-avatar{
      width:44px; height:44px;
      border-radius:999px;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:'Poppins';
      font-weight:900;
      color:#0d3b66;
      background: linear-gradient(135deg, rgba(76,175,143,0.20), rgba(27,127,90,0.20));
      border:1px solid rgba(27,127,90,0.18);
      overflow:hidden;
    }
    .mini-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    .rowmain{ flex:1; min-width:0; }
    .rowmain strong{
      display:block;
      font-family:'Poppins';
      font-size:13.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rowmain .meta{
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:#666;
      font-size:12.5px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      font-weight:800;
      color:#0d3b66;
      max-width: 100%;
    }
    .chip span{
      opacity:.9;
      font-weight:700;
      color:#2e2e2e;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }

    .controls{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      flex:0 0 auto;
    }
    .ctrl-row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .select, .input{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      background:#fff;
      font-size:13px;
      outline:none;
      min-width: 160px;
    }
    .input{ min-width: 220px; }
    .select:focus, .input:focus{
      border-color: rgba(27,127,90,0.55);
      box-shadow: 0 0 0 4px rgba(27,127,90,0.10);
    }

    /* Forms */
    .formgrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .field label{
      display:block;
      font-size:12.5px;
      font-weight:800;
      color:#444;
      margin: 0 0 6px;
    }
    .field small{
      display:block;
      margin-top:6px;
      font-size:12px;
      color:#666;
      line-height:1.35;
    }
    textarea.input{ min-height: 96px; resize: vertical; }

    .msg{
      display:none;
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      line-height:1.35;
      margin-top:10px;
      border:1px solid var(--border);
    }
    .msg.show{ display:block; }
    .msg.success{
      background: rgba(76,175,143,0.14);
      border-color: rgba(76,175,143,0.28);
      color:#135a41;
    }
    .msg.error{
      background: rgba(242,201,76,0.18);
      border-color: rgba(242,201,76,0.34);
      color:#5b4a12;
    }

    .empty{
      padding:14px;
      border:1px dashed rgba(13,59,102,0.25);
      border-radius:16px;
      background:#fff;
      color:#4a4a4a;
      font-size:13px;
      line-height:1.5;
    }

    /* Responsive */
    @media (max-width: 1050px){
      .grid.cols-4{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .sidebar-bottom{ position:relative; left:0; right:0; bottom:0; margin-top:12px; }
      .formgrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-title" translate="no">
        <strong>Governan√ßa</strong>
        <span>Administra√ß√£o do Hub</span>
      </div>

      <div class="profile" aria-label="Perfil do administrador" translate="no">
        <div class="avatar" id="avatarBox">AD</div>
        <div class="pmeta">
          <strong id="adminName">Carregando...</strong>
          <div class="sub" id="adminRole">Perfil: ‚Äî</div>
          <div class="sub" id="adminEmail">‚Äî</div>
        </div>
      </div>

      <div class="bio" id="adminBio" translate="no">
        Carregando...
      </div>

      <nav class="nav" id="navMenu" aria-label="Menu Governan√ßa" translate="no">
        <a data-view="dashboard" class="active"><span class="dot"></span> Painel geral</a>
        <a data-view="users"><span class="dot"></span> Gest√£o de Usu√°rios</a>
        <a data-view="posts"><span class="dot"></span> Feed (Posts)</a>
        <a data-view="crgr"><span class="dot"></span> Gest√£o de Territ√≥rios / CRGR</a>
        <a data-view="plans"><span class="dot"></span> Gest√£o de Planos de a√ß√£o</a>
        <a data-view="contents"><span class="dot"></span> Gest√£o de Conte√∫dos</a>
      </nav>

      <div class="sidebar-bottom">
        <button id="goHomeBtn" class="btn-ghost" translate="no"><span class="dot"></span> Voltar para Home</button>
        <button id="logoutBtn" class="btn-ghost" translate="no"><span class="dot"></span> Sair</button>
        <div translate="no">Plataforma Regenera ‚Ä¢ v0.1</div>
      </div>
    </aside>

    <!-- Content -->
    <main class="content">
      <!-- Topbar -->
      <div class="topbar" translate="no">
        <div class="top-left">
          <h2 id="viewTitle">Painel geral</h2>
          <div class="muted top-sub" id="viewSubtitle">Vis√£o geral do Hub + acompanhamento + feed recente</div>
        </div>

        <div class="search" aria-label="Pesquisar">
          <span style="opacity:.65;">üîé</span>
          <input id="searchInput" placeholder="Pesquisar (usu√°rios, posts, CRGR)..." />
        </div>

        <button class="pillbtn primary" id="primaryActionBtn" type="button">‚ûï Criar</button>
      </div>

      <!-- Views -->
      <section id="view-dashboard" class="view">
        <div class="panel">
          <div class="section-title">
            <div>
              <h3>Painel Geral: vis√£o geral do Hub</h3>
              <div class="muted">Contadores s√£o carregados do Firestore. (MVP: contagem via leitura)</div>
            </div>
            <div class="badge" id="badgeLive">Ao vivo</div>
          </div>

          <div class="grid cols-4">
            <div class="kpi">
              <strong>N¬∫ de CRGR ativos</strong>
              <div class="num" id="kpiCrgrActive">‚Äî</div>
              <div class="hint">CRGR com status ‚Äúativo‚Äù</div>
            </div>
            <div class="kpi">
              <strong>N¬∫ de usu√°rios cadastrados</strong>
              <div class="num" id="kpiUsers">‚Äî</div>
              <div class="hint">Perfis na cole√ß√£o users</div>
            </div>
            <div class="kpi">
              <strong>Planos de a√ß√£o em andamento</strong>
              <div class="num" id="kpiPlans">‚Äî</div>
              <div class="hint">status ‚Äúem_andamento‚Äù</div>
            </div>
            <div class="kpi">
              <strong>Indicadores cr√≠ticos em alerta</strong>
              <div class="num" id="kpiAlerts">‚Äî</div>
              <div class="hint">MVP: cole√ß√£o ‚Äúalerts‚Äù (opcional)</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="section-title">
            <div>
              <h3>Feed recente (posts)</h3>
              <div class="muted">Mostra os √∫ltimos posts publicados.</div>
            </div>
            <button class="pillbtn" id="refreshDashboardBtn" type="button">üîÑ Atualizar</button>
          </div>

          <div id="dashboardPosts" class="list"></div>
          <div id="dashboardPostsEmpty" class="empty" style="display:none;">Ainda n√£o h√° posts.</div>
        </div>
      </section>

      <section id="view-users" class="view" style="display:none;">
        <div class="panel">
          <div class="section-title">
            <div>
              <h3>Gest√£o de Usu√°rios</h3>
              <div class="muted">Liste, filtre por perfil e edite role / territ√≥rio / CRGR / m√≥dulos.</div>
            </div>
            <button class="pillbtn" id="refreshUsersBtn" type="button">üîÑ Atualizar</button>
          </div>

          <div class="tabs" id="roleTabs"></div>

          <div id="usersList" class="list"></div>
          <div id="usersEmpty" class="empty" style="display:none;">Nenhum usu√°rio encontrado.</div>

          <div class="msg" id="usersMsg"></div>
        </div>
      </section>

      <section id="view-posts" class="view" style="display:none;">
        <div class="panel">
          <div class="section-title">
            <div>
              <h3>Feed (Posts)</h3>
              <div class="muted">Somente admin cria/edita. Todos logados leem (conforme rules).</div>
            </div>
            <button class="pillbtn" id="refreshPostsBtn" type="button">üîÑ Atualizar</button>
          </div>

          <div class="grid cols-2">
            <div class="panel" style="padding:12px;">
              <h3 style="font-size:14px; margin-bottom:8px;">Criar novo post</h3>
              <div class="muted" style="margin-bottom:10px;">Scope (visibilidade) opcional. MVP: global.</div>

              <div class="formgrid">
                <div class="field">
                  <label>Autor (nome)</label>
                  <input class="input" id="postAuthorName" placeholder="Ex: Governan√ßa" />
                </div>
                <div class="field">
                  <label>Autor (cargo)</label>
                  <input class="input" id="postAuthorRole" placeholder="Ex: Administra√ß√£o" />
                </div>
                <div class="field" style="grid-column:1 / -1;">
                  <label>Texto</label>
                  <textarea class="input" id="postText" placeholder="Escreva o comunicado..."></textarea>
                </div>
                <div class="field">
                  <label>Tags (separadas por v√≠rgula)</label>
                  <input class="input" id="postTags" placeholder="governanca, reciclagem, alerta" />
                </div>
                <div class="field">
                  <label>Scope</label>
                  <select class="select" id="postScopeType">
                    <option value="global">Global</option>
                    <option value="territory">Territ√≥rio</option>
                    <option value="crgr">CRGR</option>
                  </select>
                  <small>Se escolher territ√≥rio/CRGR, informe o ID abaixo.</small>
                </div>
                <div class="field" style="grid-column:1 / -1;">
                  <label>Scope ID (opcional)</label>
                  <input class="input" id="postScopeId" placeholder="Ex: porto-alegre ou vila-pinto" />
                </div>
              </div>

              <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                <button class="pillbtn primary" id="createPostBtn" type="button">‚ûï Publicar</button>
                <button class="pillbtn" id="clearPostFormBtn" type="button">üßπ Limpar</button>
              </div>

              <div class="msg" id="postsMsg"></div>
            </div>

            <div class="panel" style="padding:12px;">
              <h3 style="font-size:14px; margin-bottom:8px;">Posts existentes</h3>
              <div class="muted" style="margin-bottom:10px;">Lista dos √∫ltimos 60 posts.</div>

              <div id="postsList" class="list"></div>
              <div id="postsEmpty" class="empty" style="display:none;">Ainda n√£o h√° posts.</div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-crgr" class="view" style="display:none;">
        <div class="panel">
          <div class="section-title">
            <div>
              <h3>Gest√£o de Territ√≥rios / CRGR</h3>
              <div class="muted">Cadastre CRGR, marque ativo/inativo e mantenha dados principais.</div>
            </div>
            <button class="pillbtn" id="refreshCrgrBtn" type="button">üîÑ Atualizar</button>
          </div>

          <div class="grid cols-2">
            <div class="panel" style="padding:12px;">
              <h3 style="font-size:14px; margin-bottom:8px;">Cadastrar / Atualizar CRGR</h3>

              <div class="formgrid">
                <div class="field">
                  <label>ID do CRGR (slug)</label>
                  <input class="input" id="crgrId" placeholder="Ex: vila-pinto" />
                  <small>Use h√≠fen e min√∫sculas. Esse vira o docId.</small>
                </div>
                <div class="field">
                  <label>Status</label>
                  <select class="select" id="crgrStatus">
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                  </select>
                </div>

                <div class="field">
                  <label>Nome</label>
                  <input class="input" id="crgrName" placeholder="Ex: CRGR Vila Pinto" />
                </div>
                <div class="field">
                  <label>TerritoryId</label>
                  <input class="input" id="crgrTerritoryId" placeholder="Ex: porto-alegre" />
                </div>

                <div class="field">
                  <label>OrgId</label>
                  <input class="input" id="crgrOrgId" placeholder="Ex: cooperativa-vila-pinto" />
                </div>
                <div class="field">
                  <label>Cidade / UF</label>
                  <input class="input" id="crgrCityUf" placeholder="Ex: Porto Alegre / RS" />
                </div>

                <div class="field" style="grid-column:1 / -1;">
                  <label>Endere√ßo (opcional)</label>
                  <input class="input" id="crgrAddress" placeholder="Rua..., bairro..., n¬∫..." />
                </div>

                <div class="field">
                  <label>Contato (telefone)</label>
                  <input class="input" id="crgrPhone" placeholder="(51) ..." />
                </div>
                <div class="field">
                  <label>Contato (email)</label>
                  <input class="input" id="crgrEmail" placeholder="contato@..." />
                </div>
              </div>

              <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                <button class="pillbtn primary" id="saveCrgrBtn" type="button">üíæ Salvar CRGR</button>
                <button class="pillbtn" id="loadCrgrBtn" type="button">üì• Carregar por ID</button>
                <button class="pillbtn" id="clearCrgrFormBtn" type="button">üßπ Limpar</button>
              </div>

              <div class="msg" id="crgrMsg"></div>
            </div>

            <div class="panel" style="padding:12px;">
              <h3 style="font-size:14px; margin-bottom:8px;">CRGR cadastrados</h3>
              <div class="muted" style="margin-bottom:10px;">Clique em um item para carregar no formul√°rio.</div>

              <div id="crgrList" class="list"></div>
              <div id="crgrEmpty" class="empty" style="display:none;">Nenhum CRGR cadastrado.</div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-plans" class="view" style="display:none;">
        <div class="panel">
          <div class="section-title">
            <div>
              <h3>Gest√£o de Planos de a√ß√£o</h3>
              <div class="muted">Vamos ligar em seguida: planos por CRGR, metas, respons√°veis, status e prazos.</div>
            </div>
            <span class="badge">Em implementa√ß√£o</span>
          </div>
          <div class="empty">Pr√≥ximo passo: criar cole√ß√£o <strong>plans</strong> (ou subcole√ß√£o em crgr) e renderizar em Kanban simples.</div>
        </div>
      </section>

      <section id="view-contents" class="view" style="display:none;">
        <div class="panel">
          <div class="section-title">
            <div>
              <h3>Gest√£o de Conte√∫dos</h3>
              <div class="muted">Biblioteca, temas, trilhas e registro de participa√ß√£o.</div>
            </div>
            <span class="badge">Em implementa√ß√£o</span>
          </div>
          <div class="empty">Pr√≥ximo passo: cole√ß√£o <strong>contents</strong>, temas, trilhas e logs de acesso em <strong>logs</strong>.</div>
        </div>
      </section>

      <div class="panel" id="globalMsgPanel" style="display:none;">
        <div class="msg show error" id="globalMsg"></div>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      query,
      orderBy,
      limit,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // Firebase config (o seu)
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyA8LPTZD7LA_CW2fOnJXJlVe6pByLyrRzo",
      authDomain: "hub-resiliencia-climatica.firebaseapp.com",
      projectId: "hub-resiliencia-climatica",
      storageBucket: "hub-resiliencia-climatica.firebasestorage.app",
      messagingSenderId: "485694309026",
      appId: "1:485694309026:web:771ed497d49861fa444dfb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // Defaults / Permiss√µes
    // =========================
    const DEFAULT_MODULES_BY_ROLE = {
      comunidade: { feed:true, territorio:true, biblioteca:true, forum:true, agenda:false, planos:false, dashboards:false, forms:true, observatorio:false, admin:false },
      lideranca:  { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:false, forms:true, observatorio:false, admin:false },
      tecnico:    { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  forms:true, observatorio:true,  admin:false },
      gestor:     { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  forms:true, observatorio:true,  admin:false },
      admin:      { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  forms:true, observatorio:true,  admin:true  }
    };

    function resolveModules(profile){
      const role = (profile?.role || "comunidade").toString();
      const defaults = DEFAULT_MODULES_BY_ROLE[role] || DEFAULT_MODULES_BY_ROLE.comunidade;
      const custom = (profile?.modules && typeof profile.modules === "object") ? profile.modules : {};
      return { ...defaults, ...custom };
    }

    function initialsFrom(str){
      const s = (str || "").trim();
      if(!s) return "AD";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function setAvatar(el, photoURL, fallback){
      el.innerHTML = "";
      if(photoURL){
        const img = document.createElement("img");
        img.src = photoURL;
        img.alt = "Avatar";
        el.appendChild(img);
      }else{
        el.textContent = fallback;
      }
    }

    function safeStr(v){ return (v ?? "").toString(); }

    function fmtDate(ts){
      try{
        if(!ts) return "‚Äî";
        if(ts.toDate) return ts.toDate().toLocaleString("pt-BR");
        return String(ts);
      }catch{ return "‚Äî"; }
    }

    function showMsg(el, type, text){
      el.className = "msg show " + (type === "error" ? "error" : "success");
      el.textContent = text;
    }
    function hideMsg(el){
      el.className = "msg";
      el.textContent = "";
    }

    // =========================
    // UI refs
    // =========================
    const avatarBox = document.getElementById("avatarBox");
    const adminNameEl = document.getElementById("adminName");
    const adminRoleEl = document.getElementById("adminRole");
    const adminEmailEl = document.getElementById("adminEmail");
    const adminBioEl = document.getElementById("adminBio");

    const navMenu = document.getElementById("navMenu");
    const viewTitle = document.getElementById("viewTitle");
    const viewSubtitle = document.getElementById("viewSubtitle");
    const searchInput = document.getElementById("searchInput");
    const primaryActionBtn = document.getElementById("primaryActionBtn");

    const views = {
      dashboard: document.getElementById("view-dashboard"),
      users: document.getElementById("view-users"),
      posts: document.getElementById("view-posts"),
      crgr: document.getElementById("view-crgr"),
      plans: document.getElementById("view-plans"),
      contents: document.getElementById("view-contents")
    };

    const globalMsgPanel = document.getElementById("globalMsgPanel");
    const globalMsg = document.getElementById("globalMsg");

    // Dashboard KPIs
    const kpiCrgrActive = document.getElementById("kpiCrgrActive");
    const kpiUsers = document.getElementById("kpiUsers");
    const kpiPlans = document.getElementById("kpiPlans");
    const kpiAlerts = document.getElementById("kpiAlerts");
    const dashboardPosts = document.getElementById("dashboardPosts");
    const dashboardPostsEmpty = document.getElementById("dashboardPostsEmpty");

    // Users
    const roleTabs = document.getElementById("roleTabs");
    const usersList = document.getElementById("usersList");
    const usersEmpty = document.getElementById("usersEmpty");
    const usersMsg = document.getElementById("usersMsg");
    const refreshUsersBtn = document.getElementById("refreshUsersBtn");

    // Posts
    const postsList = document.getElementById("postsList");
    const postsEmpty = document.getElementById("postsEmpty");
    const postsMsg = document.getElementById("postsMsg");
    const refreshPostsBtn = document.getElementById("refreshPostsBtn");

    const postAuthorName = document.getElementById("postAuthorName");
    const postAuthorRole = document.getElementById("postAuthorRole");
    const postText = document.getElementById("postText");
    const postTags = document.getElementById("postTags");
    const postScopeType = document.getElementById("postScopeType");
    const postScopeId = document.getElementById("postScopeId");
    const createPostBtn = document.getElementById("createPostBtn");
    const clearPostFormBtn = document.getElementById("clearPostFormBtn");

    // CRGR
    const crgrList = document.getElementById("crgrList");
    const crgrEmpty = document.getElementById("crgrEmpty");
    const crgrMsg = document.getElementById("crgrMsg");
    const refreshCrgrBtn = document.getElementById("refreshCrgrBtn");

    const crgrId = document.getElementById("crgrId");
    const crgrStatus = document.getElementById("crgrStatus");
    const crgrName = document.getElementById("crgrName");
    const crgrTerritoryId = document.getElementById("crgrTerritoryId");
    const crgrOrgId = document.getElementById("crgrOrgId");
    const crgrCityUf = document.getElementById("crgrCityUf");
    const crgrAddress = document.getElementById("crgrAddress");
    const crgrPhone = document.getElementById("crgrPhone");
    const crgrEmail = document.getElementById("crgrEmail");
    const saveCrgrBtn = document.getElementById("saveCrgrBtn");
    const loadCrgrBtn = document.getElementById("loadCrgrBtn");
    const clearCrgrFormBtn = document.getElementById("clearCrgrFormBtn");

    const refreshDashboardBtn = document.getElementById("refreshDashboardBtn");

    let sessionUser = null;
    let sessionProfile = null;

    // =========================
    // Navega√ß√£o (views)
    // =========================
    const VIEW_META = {
      dashboard: { title:"Painel geral", subtitle:"Vis√£o geral do Hub + acompanhamento + feed recente", action:"üîÑ Atualizar" },
      users: { title:"Gest√£o de Usu√°rios", subtitle:"Perfis, permiss√µes, territ√≥rios e CRGR", action:"‚ûï (em breve) Convidar" },
      posts: { title:"Feed (Posts)", subtitle:"Publica√ß√µes oficiais (admin cria)", action:"‚ûï Criar post" },
      crgr: { title:"Gest√£o de Territ√≥rios / CRGR", subtitle:"Cadastro e controle de CRGR", action:"‚ûï Cadastrar CRGR" },
      plans: { title:"Gest√£o de Planos de a√ß√£o", subtitle:"Planos por CRGR (Kanban simples)", action:"‚ûï Criar plano" },
      contents: { title:"Gest√£o de Conte√∫dos", subtitle:"Biblioteca, temas e trilhas", action:"‚ûï Adicionar conte√∫do" }
    };

    function setActiveView(viewKey){
      Object.keys(views).forEach(k => views[k].style.display = (k === viewKey ? "block" : "none"));
      viewTitle.textContent = VIEW_META[viewKey]?.title || "Admin";
      viewSubtitle.textContent = VIEW_META[viewKey]?.subtitle || "";

      // menu highlight
      [...navMenu.querySelectorAll("a[data-view]")].forEach(a => {
        a.classList.toggle("active", a.getAttribute("data-view") === viewKey);
      });

      // Primary action
      const actionLabel = VIEW_META[viewKey]?.action || "‚ûï Criar";
      primaryActionBtn.textContent = actionLabel;

      primaryActionBtn.onclick = async () => {
        if(viewKey === "dashboard"){
          await loadDashboard();
        }else if(viewKey === "posts"){
          // foca no form
          postText?.focus();
        }else if(viewKey === "crgr"){
          crgrId?.focus();
        }else{
          alert("Essa a√ß√£o ser√° implementada no pr√≥ximo passo.");
        }
      };
    }

    navMenu.addEventListener("click", (e) => {
      const a = e.target.closest("a[data-view]");
      if(!a) return;
      const viewKey = a.getAttribute("data-view");
      setActiveView(viewKey);
    });

    // =========================
    // Firestore helpers
    // =========================
    async function ensureProfile(user){
      const uref = doc(db, "users", user.uid);
      const snap = await getDoc(uref);

      if(!snap.exists()){
        const email = user.email ?? null;
        const defaultName = user.displayName || (email ? email.split("@")[0] : "Usu√°rio");
        await setDoc(uref, {
          uid: user.uid,
          email,
          name: defaultName,
          role: "comunidade",
          crgrIds: [],
          territoryId: null,
          orgId: null,
          modules: {},
          bio: "Mini bio: descreva sua atua√ß√£o no territ√≥rio.",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
        const again = await getDoc(uref);
        return again.data();
      }

      // garante m√≥dulos default (merge)
      const data = snap.data();
      const role = (data?.role || "comunidade").toString();
      const resolved = resolveModules(data);

      // se n√£o tiver modules, aplica defaults sem sobrescrever custom
      if(!data.modules || typeof data.modules !== "object"){
        await setDoc(uref, { modules: resolved, updatedAt: serverTimestamp() }, { merge:true });
        const again = await getDoc(uref);
        return again.data();
      }

      // se n√£o tiver admin true e role admin, garante admin
      if(role === "admin" && data?.modules?.admin !== true){
        await setDoc(uref, { modules: { ...(data.modules||{}), admin:true }, updatedAt: serverTimestamp() }, { merge:true });
        const again = await getDoc(uref);
        return again.data();
      }

      return data;
    }

    function profileIsAdmin(profile){
      const modules = resolveModules(profile);
      return profile?.role === "admin" || modules.admin === true;
    }

    // =========================
    // Dashboard
    // =========================
    async function countUsers(){
      const snap = await getDocs(query(collection(db, "users"), limit(5000)));
      return snap.size;
    }

    async function countCrgrActive(){
      // MVP: l√™ at√© 5000 e filtra no client (sem index)
      const snap = await getDocs(query(collection(db, "crgr"), limit(5000)));
      let active = 0;
      snap.forEach(d => {
        const s = (d.data()?.status || "ativo").toString();
        if(s === "ativo") active++;
      });
      return { total: snap.size, active };
    }

    async function countPlansInProgress(){
      // se n√£o existir cole√ß√£o plans ainda, retorna 0 sem quebrar
      try{
        const snap = await getDocs(query(collection(db, "plans"), limit(5000)));
        let c = 0;
        snap.forEach(d => {
          if((d.data()?.status || "") === "em_andamento") c++;
        });
        return c;
      }catch{
        return 0;
      }
    }

    async function countAlerts(){
      // opcional: se n√£o existir cole√ß√£o alerts, retorna 0
      try{
        const snap = await getDocs(query(collection(db, "alerts"), limit(5000)));
        let c = 0;
        snap.forEach(d => {
          if((d.data()?.status || "ativo") === "ativo") c++;
        });
        return c;
      }catch{
        return 0;
      }
    }

    async function fetchRecentPosts(){
      try{
        const qAll = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(8));
        const snap = await getDocs(qAll);
        return snap.docs.map(d => ({ id:d.id, ...d.data() }));
      }catch{
        const snap = await getDocs(query(collection(db, "posts"), limit(8)));
        const arr = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        arr.sort((a,b) => {
          const at = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
          const bt = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
          return bt - at;
        });
        return arr;
      }
    }

    function renderSmallPost(targetEl, post){
      const card = document.createElement("div");
      card.className = "rowcard";

      const av = document.createElement("div");
      av.className = "mini-avatar";
      av.textContent = initialsFrom(post.authorName || "Admin");

      const main = document.createElement("div");
      main.className = "rowmain";
      main.innerHTML = `
        <strong>${safeStr(post.authorName || "Admin")}</strong>
        <div class="meta">
          <span>${safeStr(post.authorRole || "‚Äî")}</span>
          <span>‚Ä¢</span>
          <span>${fmtDate(post.createdAt)}</span>
        </div>
        <div class="muted" style="margin-top:8px; white-space:pre-wrap;">${safeStr(post.text || "").slice(0, 220)}${(safeStr(post.text||"").length>220)?"‚Ä¶":""}</div>
      `;

      card.appendChild(av);
      card.appendChild(main);
      targetEl.appendChild(card);
    }

    async function loadDashboard(){
      dashboardPosts.innerHTML = "";
      dashboardPostsEmpty.style.display = "none";

      const [usersCount, crgrInfo, plansCount, alertsCount, recentPosts] = await Promise.all([
        countUsers(),
        countCrgrActive(),
        countPlansInProgress(),
        countAlerts(),
        fetchRecentPosts()
      ]);

      kpiUsers.textContent = usersCount;
      kpiCrgrActive.textContent = crgrInfo.active;
      kpiPlans.textContent = plansCount;
      kpiAlerts.textContent = alertsCount;

      if(!recentPosts.length){
        dashboardPostsEmpty.style.display = "block";
      }else{
        recentPosts.forEach(p => renderSmallPost(dashboardPosts, p));
      }
    }

    refreshDashboardBtn.addEventListener("click", loadDashboard);

    // =========================
    // Users management
    // =========================
    const ROLE_ORDER = ["todos","comunidade","lideranca","tecnico","gestor","admin"];
    const ROLE_LABEL = {
      todos:"Todos",
      comunidade:"Comunidade",
      lideranca:"Lideran√ßa comunit√°ria",
      tecnico:"T√©cnico",
      gestor:"Gestor",
      admin:"Administrador"
    };

    let currentRoleFilter = "todos";
    let usersCache = [];

    function renderRoleTabs(){
      roleTabs.innerHTML = "";
      ROLE_ORDER.forEach(r => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "tab" + (r === currentRoleFilter ? " active" : "");
        b.textContent = ROLE_LABEL[r] || r;
        b.addEventListener("click", () => {
          currentRoleFilter = r;
          renderRoleTabs();
          renderUsersList();
        });
        roleTabs.appendChild(b);
      });
    }

    async function fetchUsers(){
      const snap = await getDocs(query(collection(db, "users"), limit(5000)));
      const arr = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      arr.sort((a,b) => (safeStr(a.name)).localeCompare(safeStr(b.name), "pt-BR"));
      return arr;
    }

    function userMatchesSearch(u, q){
      const s = (q||"").trim().toLowerCase();
      if(!s) return true;
      const hay = [
        u.name, u.email, u.role, u.territoryId,
        Array.isArray(u.crgrIds) ? u.crgrIds.join(" ") : "",
        u.orgId
      ].join(" ").toLowerCase();
      return hay.includes(s);
    }

    function renderUsersList(){
      usersList.innerHTML = "";
      usersEmpty.style.display = "none";

      const q = searchInput.value;
      let list = usersCache.filter(u => userMatchesSearch(u, q));
      if(currentRoleFilter !== "todos"){
        list = list.filter(u => (u.role || "comunidade") === currentRoleFilter);
      }

      if(!list.length){
        usersEmpty.style.display = "block";
        return;
      }

      list.forEach(u => {
        const row = document.createElement("div");
        row.className = "rowcard";

        const av = document.createElement("div");
        av.className = "mini-avatar";
        if(u.photoURL){
          const img = document.createElement("img");
          img.src = u.photoURL;
          img.alt = "Avatar";
          av.appendChild(img);
        }else{
          av.textContent = initialsFrom(u.name || u.email || "U");
        }

        const main = document.createElement("div");
        main.className = "rowmain";

        const crgrText = Array.isArray(u.crgrIds) && u.crgrIds.length ? u.crgrIds.join(", ") : "‚Äî";
        const territoryText = u.territoryId || "‚Äî";

        main.innerHTML = `
          <strong>${safeStr(u.name || "Sem nome")}</strong>
          <div class="meta">
            <span>${safeStr(u.email || "‚Äî")}</span>
            <span>‚Ä¢</span>
            <span>${safeStr(u.role || "comunidade")}</span>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
            <div class="chip"><strong>Territ√≥rio</strong> <span title="${safeStr(territoryText)}">${safeStr(territoryText)}</span></div>
            <div class="chip"><strong>CRGR</strong> <span title="${safeStr(crgrText)}">${safeStr(crgrText)}</span></div>
          </div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        const roleSel = document.createElement("select");
        roleSel.className = "select";
        ["comunidade","lideranca","tecnico","gestor","admin"].forEach(r => {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = ROLE_LABEL[r] || r;
          if((u.role || "comunidade") === r) opt.selected = true;
          roleSel.appendChild(opt);
        });

        const territoryInput = document.createElement("input");
        territoryInput.className = "input";
        territoryInput.placeholder = "territoryId (ex: porto-alegre)";
        territoryInput.value = safeStr(u.territoryId || "");

        const crgrInput = document.createElement("input");
        crgrInput.className = "input";
        crgrInput.placeholder = "crgrIds (ex: vila-pinto, outro-crgr)";
        crgrInput.value = Array.isArray(u.crgrIds) ? u.crgrIds.join(", ") : "";

        const saveBtn = document.createElement("button");
        saveBtn.className = "pillbtn primary";
        saveBtn.type = "button";
        saveBtn.textContent = "üíæ Salvar";

        saveBtn.addEventListener("click", async () => {
          hideMsg(usersMsg);
          saveBtn.disabled = true;
          saveBtn.style.opacity = "0.85";

          try{
            const newRole = roleSel.value;
            const newTerritoryId = territoryInput.value.trim() || null;
            const rawCrgr = crgrInput.value.split(",").map(s => s.trim()).filter(Boolean);
            const newCrgrIds = rawCrgr.length ? rawCrgr : [];

            // se mudar role, atualiza defaults e mant√©m custom
            const defaults = DEFAULT_MODULES_BY_ROLE[newRole] || DEFAULT_MODULES_BY_ROLE.comunidade;
            const existingModules = (u.modules && typeof u.modules === "object") ? u.modules : {};
            const mergedModules = { ...defaults, ...existingModules };

            // garante admin module se role admin
            if(newRole === "admin") mergedModules.admin = true;

            await updateDoc(doc(db, "users", u.id), {
              role: newRole,
              territoryId: newTerritoryId,
              crgrIds: newCrgrIds,
              modules: mergedModules,
              updatedAt: serverTimestamp()
            });

            // atualiza cache local
            u.role = newRole;
            u.territoryId = newTerritoryId;
            u.crgrIds = newCrgrIds;
            u.modules = mergedModules;

            showMsg(usersMsg, "success", "Usu√°rio atualizado com sucesso!");
            renderUsersList();
          }catch(err){
            console.error(err);
            showMsg(usersMsg, "error", "Erro ao salvar usu√°rio. Verifique rules/permiss√µes.");
          }finally{
            saveBtn.disabled = false;
            saveBtn.style.opacity = "1";
          }
        });

        const mini = document.createElement("div");
        mini.className = "ctrl-row";
        mini.appendChild(roleSel);

        const mini2 = document.createElement("div");
        mini2.className = "ctrl-row";
        mini2.appendChild(territoryInput);

        const mini3 = document.createElement("div");
        mini3.className = "ctrl-row";
        mini3.appendChild(crgrInput);

        const mini4 = document.createElement("div");
        mini4.className = "ctrl-row";
        mini4.appendChild(saveBtn);

        controls.appendChild(mini);
        controls.appendChild(mini2);
        controls.appendChild(mini3);
        controls.appendChild(mini4);

        row.appendChild(av);
        row.appendChild(main);
        row.appendChild(controls);
        usersList.appendChild(row);
      });
    }

    async function loadUsers(){
      hideMsg(usersMsg);
      usersList.innerHTML = "";
      usersEmpty.style.display = "none";
      usersEmpty.textContent = "Carregando...";

      try{
        usersCache = await fetchUsers();
        renderRoleTabs();
        renderUsersList();
      }catch(err){
        console.error(err);
        usersEmpty.style.display = "block";
        usersEmpty.textContent = "Erro ao carregar usu√°rios. Verifique permiss√µes / rules.";
      }
    }

    refreshUsersBtn.addEventListener("click", loadUsers);

    // =========================
    // Posts management (create + list)
    // =========================
    async function fetchPosts(){
      try{
        const snap = await getDocs(query(collection(db, "posts"), orderBy("createdAt","desc"), limit(60)));
        return snap.docs.map(d => ({ id:d.id, ...d.data() }));
      }catch{
        const snap = await getDocs(query(collection(db, "posts"), limit(60)));
        const arr = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        arr.sort((a,b) => {
          const at = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
          const bt = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
          return bt - at;
        });
        return arr;
      }
    }

    function renderPostRow(targetEl, post){
      const row = document.createElement("div");
      row.className = "rowcard";

      const av = document.createElement("div");
      av.className = "mini-avatar";
      av.textContent = initialsFrom(post.authorName || "Admin");

      const main = document.createElement("div");
      main.className = "rowmain";
      const tags = Array.isArray(post.tags) ? post.tags.slice(0,8).map(t => `#${t}`).join(" ") : "";
      const scopeType = post?.scope?.type || "global";
      const scopeId = post?.scope?.id || "";
      main.innerHTML = `
        <strong>${safeStr(post.authorName || "Admin")}</strong>
        <div class="meta">
          <span>${safeStr(post.authorRole || "‚Äî")}</span>
          <span>‚Ä¢</span>
          <span>${fmtDate(post.createdAt)}</span>
          <span>‚Ä¢</span>
          <span>scope: ${safeStr(scopeType)}${scopeId ? " ("+safeStr(scopeId)+")" : ""}</span>
        </div>
        <div class="muted" style="margin-top:8px; white-space:pre-wrap;">${safeStr(post.text || "")}</div>
        ${tags ? `<div style="margin-top:8px;" class="muted">${tags}</div>` : ""}
      `;

      row.appendChild(av);
      row.appendChild(main);
      targetEl.appendChild(row);
    }

    async function loadPosts(){
      hideMsg(postsMsg);
      postsList.innerHTML = "";
      postsEmpty.style.display = "none";

      try{
        const posts = await fetchPosts();
        if(!posts.length){
          postsEmpty.style.display = "block";
          return;
        }
        posts.forEach(p => renderPostRow(postsList, p));
      }catch(err){
        console.error(err);
        postsEmpty.style.display = "block";
        postsEmpty.textContent = "Erro ao carregar posts. Verifique rules/permiss√µes.";
      }
    }

    refreshPostsBtn.addEventListener("click", loadPosts);

    clearPostFormBtn.addEventListener("click", () => {
      postAuthorName.value = "";
      postAuthorRole.value = "";
      postText.value = "";
      postTags.value = "";
      postScopeType.value = "global";
      postScopeId.value = "";
      hideMsg(postsMsg);
    });

    createPostBtn.addEventListener("click", async () => {
      hideMsg(postsMsg);

      const text = postText.value.trim();
      if(!text) return showMsg(postsMsg, "error", "Escreva o texto do post.");

      const authorName = postAuthorName.value.trim() || (sessionProfile?.name || "Admin");
      const authorRole = postAuthorRole.value.trim() || "Governan√ßa";
      const tags = postTags.value.split(",").map(s => s.trim()).filter(Boolean);
      const scopeType = postScopeType.value;
      const scopeId = postScopeId.value.trim() || null;

      // cria docId autom√°tico via setDoc em doc() com id random? (vamos usar add via setDoc com doc auto)
      // Como estamos usando imports minimalistas, vamos usar setDoc(doc(collection...)) com docId auto.
      // (o firebase v10 permite doc(collectionRef) gerar id auto)
      try{
        createPostBtn.disabled = true;
        createPostBtn.style.opacity = "0.85";

        const colRef = collection(db, "posts");
        const newRef = doc(colRef); // auto-id
        await setDoc(newRef, {
          text,
          tags,
          scope: { type: scopeType, id: scopeId },
          authorUid: sessionUser.uid,
          authorName,
          authorRole,
          authorPhotoURL: sessionUser.photoURL || sessionProfile?.photoURL || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        showMsg(postsMsg, "success", "Post publicado!");
        postText.value = "";
        await Promise.all([loadPosts(), loadDashboard()]);
      }catch(err){
        console.error(err);
        showMsg(postsMsg, "error", "Erro ao publicar. Confirme se voc√™ √© admin nas rules.");
      }finally{
        createPostBtn.disabled = false;
        createPostBtn.style.opacity = "1";
      }
    });

    // =========================
    // CRGR management
    // =========================
    function clearCrgrForm(){
      crgrId.value = "";
      crgrStatus.value = "ativo";
      crgrName.value = "";
      crgrTerritoryId.value = "";
      crgrOrgId.value = "";
      crgrCityUf.value = "";
      crgrAddress.value = "";
      crgrPhone.value = "";
      crgrEmail.value = "";
      hideMsg(crgrMsg);
    }
    clearCrgrFormBtn.addEventListener("click", clearCrgrForm);

    async function fetchCrgr(){
      const snap = await getDocs(query(collection(db, "crgr"), limit(5000)));
      const arr = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      arr.sort((a,b) => (safeStr(a.name)).localeCompare(safeStr(b.name), "pt-BR"));
      return arr;
    }

    function renderCrgrList(list){
      crgrList.innerHTML = "";
      crgrEmpty.style.display = "none";
      if(!list.length){
        crgrEmpty.style.display = "block";
        return;
      }

      list.forEach(c => {
        const row = document.createElement("div");
        row.className = "rowcard";
        row.style.cursor = "pointer";

        const av = document.createElement("div");
        av.className = "mini-avatar";
        av.textContent = initialsFrom(c.name || c.id);

        const main = document.createElement("div");
        main.className = "rowmain";
        main.innerHTML = `
          <strong>${safeStr(c.name || c.id)}</strong>
          <div class="meta">
            <span>id: ${safeStr(c.id)}</span>
            <span>‚Ä¢</span>
            <span>status: ${safeStr(c.status || "ativo")}</span>
            <span>‚Ä¢</span>
            <span>territ√≥rio: ${safeStr(c.territoryId || "‚Äî")}</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
            <div class="chip"><strong>Org</strong> <span title="${safeStr(c.orgId||"‚Äî")}">${safeStr(c.orgId||"‚Äî")}</span></div>
            <div class="chip"><strong>Cidade</strong> <span title="${safeStr(c.address?.city || "")}">${safeStr(c.address?.city || "‚Äî")}</span></div>
          </div>
        `;

        row.appendChild(av);
        row.appendChild(main);

        row.addEventListener("click", () => {
          crgrId.value = c.id;
          crgrStatus.value = c.status || "ativo";
          crgrName.value = c.name || "";
          crgrTerritoryId.value = c.territoryId || "";
          crgrOrgId.value = c.orgId || "";
          const city = c.address?.city || "";
          const uf = c.address?.uf || "";
          crgrCityUf.value = (city || uf) ? `${city}${uf ? " / " + uf : ""}` : "";
          crgrAddress.value = c.address?.street || "";
          crgrPhone.value = c.contacts?.phone || "";
          crgrEmail.value = c.contacts?.email || "";
          showMsg(crgrMsg, "success", "CRGR carregado no formul√°rio.");
        });

        crgrList.appendChild(row);
      });
    }

    async function loadCrgrList(){
      hideMsg(crgrMsg);
      crgrList.innerHTML = "";
      crgrEmpty.style.display = "none";

      try{
        const arr = await fetchCrgr();
        // aplica busca (topbar)
        const q = (searchInput.value || "").trim().toLowerCase();
        const filtered = !q ? arr : arr.filter(c => {
          const hay = [
            c.id, c.name, c.territoryId, c.orgId,
            c.address?.city, c.address?.uf, c.status
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });

        renderCrgrList(filtered);
      }catch(err){
        console.error(err);
        crgrEmpty.style.display = "block";
        crgrEmpty.textContent = "Erro ao carregar CRGR. Verifique rules/permiss√µes.";
      }
    }

    refreshCrgrBtn.addEventListener("click", loadCrgrList);

    loadCrgrBtn.addEventListener("click", async () => {
      hideMsg(crgrMsg);
      const id = crgrId.value.trim();
      if(!id) return showMsg(crgrMsg, "error", "Informe o ID do CRGR para carregar.");

      try{
        const snap = await getDoc(doc(db, "crgr", id));
        if(!snap.exists()) return showMsg(crgrMsg, "error", "CRGR n√£o encontrado.");
        const c = { id:snap.id, ...snap.data() };

        crgrStatus.value = c.status || "ativo";
        crgrName.value = c.name || "";
        crgrTerritoryId.value = c.territoryId || "";
        crgrOrgId.value = c.orgId || "";
        const city = c.address?.city || "";
        const uf = c.address?.uf || "";
        crgrCityUf.value = (city || uf) ? `${city}${uf ? " / " + uf : ""}` : "";
        crgrAddress.value = c.address?.street || "";
        crgrPhone.value = c.contacts?.phone || "";
        crgrEmail.value = c.contacts?.email || "";

        showMsg(crgrMsg, "success", "CRGR carregado.");
      }catch(err){
        console.error(err);
        showMsg(crgrMsg, "error", "Erro ao carregar CRGR. Verifique rules.");
      }
    });

    saveCrgrBtn.addEventListener("click", async () => {
      hideMsg(crgrMsg);

      const id = crgrId.value.trim();
      if(!id) return showMsg(crgrMsg, "error", "Informe o ID do CRGR (slug).");

      const status = crgrStatus.value;
      const name = crgrName.value.trim() || id;
      const territoryId = crgrTerritoryId.value.trim() || null;
      const orgId = crgrOrgId.value.trim() || null;

      const cityUf = crgrCityUf.value.trim();
      let city = "", uf = "";
      if(cityUf.includes("/")){
        const parts = cityUf.split("/");
        city = (parts[0]||"").trim();
        uf = (parts[1]||"").trim().toUpperCase();
      }else{
        city = cityUf;
      }

      const street = crgrAddress.value.trim() || null;
      const phone = crgrPhone.value.trim() || null;
      const email = crgrEmail.value.trim() || null;

      try{
        saveCrgrBtn.disabled = true;
        saveCrgrBtn.style.opacity = "0.85";

        const ref = doc(db, "crgr", id);

        // se j√° existe, mant√©m createdAt; se n√£o, cria
        const snap = await getDoc(ref);
        const createdAt = snap.exists() ? (snap.data()?.createdAt || serverTimestamp()) : serverTimestamp();

        await setDoc(ref, {
          name,
          status,
          territoryId,
          orgId,
          address: { city: city || null, uf: uf || null, street },
          contacts: { phone, email },
          createdAt,
          updatedAt: serverTimestamp()
        }, { merge:true });

        showMsg(crgrMsg, "success", "CRGR salvo com sucesso!");
        await Promise.all([loadCrgrList(), loadDashboard()]);
      }catch(err){
        console.error(err);
        showMsg(crgrMsg, "error", "Erro ao salvar CRGR. Confirme se voc√™ √© admin nas rules.");
      }finally{
        saveCrgrBtn.disabled = false;
        saveCrgrBtn.style.opacity = "1";
      }
    });

    // =========================
    // Search behavior (topbar)
    // =========================
    searchInput.addEventListener("input", () => {
      const visibleKey = Object.keys(views).find(k => views[k].style.display !== "none") || "dashboard";
      if(visibleKey === "users"){
        renderUsersList();
      }else if(visibleKey === "posts"){
        // recarrega posts filtrando (MVP: refetch pra simplicidade)
        loadPosts();
      }else if(visibleKey === "crgr"){
        loadCrgrList();
      }else if(visibleKey === "dashboard"){
        // opcional: dashboard n√£o filtra; mantemos como est√°
      }
    });

    // =========================
    // Buttons: home / logout
    // =========================
    document.getElementById("goHomeBtn").addEventListener("click", () => {
      window.location.href = "home.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // =========================
    // Auth gate (ADMIN ONLY)
    // =========================
    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "index.html";
        return;
      }
      sessionUser = user;

      try{
        sessionProfile = await ensureProfile(user);

        const name = sessionProfile?.name || user.displayName || (user.email ? user.email.split("@")[0] : "Admin");
        const role = sessionProfile?.role || "comunidade";
        const bio = sessionProfile?.bio || "Painel de governan√ßa para administra√ß√£o do Hub.";
        const email = user.email || "‚Äî";

        setAvatar(avatarBox, user.photoURL || sessionProfile?.photoURL || null, initialsFrom(name));
        adminNameEl.textContent = name;
        adminRoleEl.textContent = `Perfil: ${role}`;
        adminEmailEl.textContent = email;
        adminBioEl.textContent = bio;

        // bloqueia se n√£o for admin
        if(!profileIsAdmin(sessionProfile)){
          globalMsgPanel.style.display = "block";
          globalMsg.textContent = "Acesso negado: voc√™ n√£o √© administrador. Retornando para a home...";
          setTimeout(() => window.location.href = "home.html", 900);
          return;
        }

        // Inicializa view e carrega dados
        setActiveView("dashboard");
        renderRoleTabs();

        await Promise.all([
          loadDashboard(),
          loadUsers(),
          loadPosts(),
          loadCrgrList()
        ]);

      }catch(err){
        console.error(err);
        globalMsgPanel.style.display = "block";
        globalMsg.textContent = "Erro ao carregar painel admin. Verifique permiss√µes (rules) e conex√£o.";
      }
    });
  </script>
</body>
</html>
