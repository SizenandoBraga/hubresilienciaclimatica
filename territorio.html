<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hub Resiliência Climática • Território / CRGR</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green-regen:#1B7F5A;
      --green-light:#4CAF8F;
      --blue-deep:#0D3B66;
      --yellow:#F2C94C;

      --graphite:#2E2E2E;
      --bg:#F5F7F6;
      --white:#FFFFFF;

      --shadow:0 10px 30px rgba(0,0,0,0.08);
      --border:#E7ECEA;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--graphite);
    }
    h1,h2,h3{ font-family:'Poppins', sans-serif; margin:0; }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea { font-family:inherit; }

    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }

    /* Sidebar (igual home) */
    .sidebar{
      position:sticky;
      top:16px;
      height: calc(100vh - 32px);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(13,59,102,0.98), rgba(27,127,90,0.98));
      box-shadow: var(--shadow);
      color:#fff;
      padding:14px;
      overflow:hidden;
    }
    .sidebar-title{
      padding:10px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.14);
      margin-bottom:12px;
    }
    .sidebar-title strong{ display:block; font-size:15px; letter-spacing:0.2px; }
    .sidebar-title span{ display:block; font-size:12.5px; opacity:.9; margin-top:4px; }

    .profile{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius:16px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
    }
    .avatar{
      width:56px; height:56px; border-radius:999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-family:'Poppins';
      letter-spacing:0.4px;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pmeta{ min-width:0; display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .pmeta strong{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pmeta .sub{ font-size:12px; opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .nav{ margin-top:12px; display:grid; gap:6px; }
    .nav a{
      cursor:pointer;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      text-align:left;
      border: 1px solid transparent;
      opacity:.96;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav a:hover{ background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.12); }
    .nav .active{ background: rgba(242,201,76,0.14); border-color: rgba(242,201,76,0.28); }

    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--yellow);
      box-shadow: 0 0 0 3px rgba(242,201,76,0.16);
      flex:0 0 auto;
    }

    .sidebar-bottom{
      position:absolute; left:14px; right:14px; bottom:12px;
      padding-top:10px; border-top:1px solid rgba(255,255,255,0.14);
      display:flex; flex-direction:column; gap:8px;
      font-size:12px; opacity:.9;
    }
    .logoutBtn{
      width:100%; border:none; cursor:pointer;
      border-radius:14px; padding:10px 12px;
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.14);
      color:#fff; font-weight:900;
      display:flex; align-items:center; gap:10px;
      text-align:left;
    }

    /* Content */
    .content{ display:flex; flex-direction:column; gap:12px; }

    .topbar{
      position:sticky; top:16px; z-index:5;
      background: rgba(245,247,246,0.82);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar h2{ font-size:16px; }
    .muted{ color:#666; font-size:13px; line-height:1.5; }

    .pillbtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      font-family:'Poppins';
      font-size:12px;
      color:var(--blue-deep);
      cursor:pointer;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:12px;
      align-items:start;
    }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .card-head{
      padding:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
    }
    .badge{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(76,175,143,0.12);
      color: var(--green-regen);
      border: 1px solid rgba(76,175,143,0.25);
      white-space:nowrap;
      font-weight:800;
      font-family:'Poppins';
    }
    .card-body{ padding:14px; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .item strong{ font-family:'Poppins'; font-size:13.5px; display:block; }
    .item span{ display:block; margin-top:4px; font-size:12.5px; color:#666; white-space:pre-wrap; }

    .empty{
      padding:16px;
      border:1px dashed rgba(13,59,102,0.25);
      border-radius:18px;
      background:#fff;
      color:#4a4a4a;
      font-size:13px;
      line-height:1.5;
    }

    /* mini feed style */
    .post{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
    }
    .post-head{
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
    }
    .post-head strong{ font-family:'Poppins'; font-size:13.5px; }
    .post-body{ padding:12px; white-space:pre-wrap; line-height:1.55; }

    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .sidebar-bottom{ position:relative; left:0; right:0; bottom:0; margin-top:12px; }
      .grid{ grid-template-columns: 1fr; }
      .topbar{ top:12px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-title" translate="no">
        <strong>Hub Resiliência Climática</strong>
        <span>Território / CRGR</span>
      </div>

      <div class="profile" translate="no">
        <div class="avatar" id="avatarBox">HR</div>
        <div class="pmeta">
          <strong id="userName">Carregando...</strong>
          <div class="sub" id="userRole">Perfil: —</div>
          <div class="sub" id="userEmail">—</div>
        </div>
      </div>

      <nav class="nav" id="navMenu" translate="no">
        <a href="home.html"><span class="dot"></span> Início (Feed)</a>
        <a class="active" href="territorio.html"><span class="dot"></span> Meu território / CRGR</a>
        <a href="admin.html" id="adminLink" style="display:none;"><span class="dot"></span> Admin</a>
      </nav>

      <div class="sidebar-bottom">
        <button id="logoutBtn" class="logoutBtn" translate="no">
          <span class="dot"></span> Sair
        </button>
        <div translate="no">Plataforma Regenera • v0.1</div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar" translate="no">
        <div style="min-width:240px;">
          <h2 id="title">Meu território / CRGR</h2>
          <div class="muted" id="subtitle">Carregando informações...</div>
        </div>

        <button class="pillbtn" id="goHomeBtn" type="button">Voltar ao Feed</button>
      </div>

      <div class="grid">
        <section class="card">
          <div class="card-head">
            <div>
              <h3 style="font-size:14px;">Visão geral da unidade</h3>
              <div class="muted" style="margin-top:4px;" id="crgrMeta">—</div>
            </div>
            <div class="badge">CRGR</div>
          </div>
          <div class="card-body">
            <div class="empty" id="crgrBox">Carregando CRGR...</div>
          </div>
        </section>

        <section class="card">
          <div class="card-head">
            <div>
              <h3 style="font-size:14px;">Membros</h3>
              <div class="muted" style="margin-top:4px;">UIDs vinculados à unidade</div>
            </div>
            <div class="badge" id="membersCount">0</div>
          </div>
          <div class="card-body">
            <div id="membersList" class="list"></div>
            <div id="membersEmpty" class="empty">Carregando membros...</div>
          </div>
        </section>
      </div>

      <section class="card">
        <div class="card-head">
          <div>
            <h3 style="font-size:14px;">Mural do território</h3>
            <div class="muted" style="margin-top:4px;">Posts com escopo do seu CRGR (MVP)</div>
          </div>
          <div class="badge" id="muralCount">0</div>
        </div>
        <div class="card-body">
          <div id="muralEmpty" class="empty">Carregando mural...</div>
          <div id="muralList" class="list"></div>
        </div>
      </section>

    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8LPTZD7LA_CW2fOnJXJlVe6pByLyrRzo",
      authDomain: "hub-resiliencia-climatica.firebaseapp.com",
      projectId: "hub-resiliencia-climatica",
      storageBucket: "hub-resiliencia-climatica.firebasestorage.app",
      messagingSenderId: "485694309026",
      appId: "1:485694309026:web:771ed497d49861fa444dfb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Permissões (mesmo padrão)
    const DEFAULT_MODULES_BY_ROLE = {
      comunidade: { feed:true, territorio:true, biblioteca:true, forum:true, agenda:false, planos:false, dashboards:false, admin:false },
      lideranca:  { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:false, admin:false },
      tecnico:    { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  admin:false },
      gestor:     { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  admin:false },
      admin:      { feed:true, territorio:true, biblioteca:true, forum:true, agenda:true,  planos:true,  dashboards:true,  admin:true  }
    };
    function resolveModules(profile){
      const role = (profile?.role || "comunidade").toString();
      const defaults = DEFAULT_MODULES_BY_ROLE[role] || DEFAULT_MODULES_BY_ROLE.comunidade;
      const custom = (profile?.modules && typeof profile.modules === "object") ? profile.modules : {};
      return { ...defaults, ...custom };
    }
    function isAdmin(profile){
      const m = resolveModules(profile);
      return profile?.role === "admin" || m.admin === true;
    }
    function canAccess(profile, key){
      const m = resolveModules(profile);
      return m[key] === true;
    }

    // ===== UI
    const avatarBox = document.getElementById("avatarBox");
    const userNameEl = document.getElementById("userName");
    const userRoleEl = document.getElementById("userRole");
    const userEmailEl = document.getElementById("userEmail");
    const adminLink = document.getElementById("adminLink");

    const titleEl = document.getElementById("title");
    const subtitleEl = document.getElementById("subtitle");

    const crgrBox = document.getElementById("crgrBox");
    const crgrMeta = document.getElementById("crgrMeta");

    const membersList = document.getElementById("membersList");
    const membersEmpty = document.getElementById("membersEmpty");
    const membersCount = document.getElementById("membersCount");

    const muralList = document.getElementById("muralList");
    const muralEmpty = document.getElementById("muralEmpty");
    const muralCount = document.getElementById("muralCount");

    document.getElementById("goHomeBtn").addEventListener("click", () => window.location.href = "home.html");

    function safeStr(v){ return (v ?? "").toString(); }
    function initialsFrom(str){
      const s = (str || "").trim();
      if(!s) return "HR";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    function setAvatar(photoURL, fallback){
      avatarBox.innerHTML = "";
      if(photoURL){
        const img = document.createElement("img");
        img.src = photoURL;
        img.alt = "Avatar";
        avatarBox.appendChild(img);
      }else{
        avatarBox.textContent = fallback;
      }
    }

    async function ensureProfile(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          uid: user.uid,
          email: user.email ?? null,
          name: user.displayName || (user.email ? user.email.split("@")[0] : "Usuário"),
          role: "comunidade",
          crgrIds: [],
          orgId: null,
          modules: {},
          bio: "Mini bio: descreva sua atuação no território.",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        const again = await getDoc(ref);
        return again.data();
      }
      return snap.data();
    }

    function renderMembers(arr){
      membersList.innerHTML = "";
      if(!arr.length){
        membersEmpty.style.display = "block";
        membersEmpty.textContent = "Sem membros vinculados ainda.";
        membersCount.textContent = "0";
        return;
      }
      membersEmpty.style.display = "none";
      membersCount.textContent = String(arr.length);

      arr.forEach(uid => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<strong>${uid}</strong><span>UID vinculado ao CRGR</span>`;
        membersList.appendChild(div);
      });
    }

    function renderMural(posts){
      muralList.innerHTML = "";
      if(!posts.length){
        muralEmpty.style.display = "block";
        muralEmpty.textContent = "Ainda não há posts no mural do seu território.";
        muralCount.textContent = "0";
        return;
      }
      muralEmpty.style.display = "none";
      muralCount.textContent = String(posts.length);

      posts.forEach(p => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <div class="post-head">
            <strong>${safeStr(p.authorName || "Admin")}</strong>
            <span class="muted">${safeStr(p.scope?.crgrId || "")}</span>
          </div>
          <div class="post-body">${safeStr(p.text || "")}</div>
        `;
        muralList.appendChild(div);
      });
    }

    async function loadCrgrAndMural(profile){
      const crgrIds = Array.isArray(profile.crgrIds) ? profile.crgrIds : [];
      if(!crgrIds.length){
        crgrBox.textContent = "Você ainda não está vinculado a nenhum CRGR. Peça ao admin para vincular seu usuário.";
        crgrMeta.textContent = "—";
        membersEmpty.textContent = "—";
        muralEmpty.textContent = "—";
        return;
      }

      // MVP: pega o primeiro CRGR
      const crgrId = crgrIds[0];
      const crgrRef = doc(db, "crgrs", crgrId);
      const crgrSnap = await getDoc(crgrRef);

      if(!crgrSnap.exists()){
        crgrBox.textContent = "CRGR não encontrado. Verifique com o admin se o ID está correto.";
        crgrMeta.textContent = `ID: ${crgrId}`;
        return;
      }

      const crgr = crgrSnap.data();
      titleEl.textContent = safeStr(crgr.name || "Meu território / CRGR");
      subtitleEl.textContent = `${safeStr(crgr.city || "—")}/${safeStr(crgr.state || "—")} • ${safeStr(crgr.territoryName || "Território")}`;
      crgrMeta.textContent = `ID: ${crgrId}`;

      crgrBox.innerHTML = `
        <div class="item" style="border:none; padding:0;">
          <strong>${safeStr(crgr.name || crgrId)}</strong>
          <span><b>Cidade/UF:</b> ${safeStr(crgr.city || "—")}/${safeStr(crgr.state || "—")}</span>
          <span><b>Território:</b> ${safeStr(crgr.territoryName || "—")}</span>
          <span style="margin-top:8px;"><b>Descrição:</b><br/>${safeStr(crgr.description || "—")}</span>
        </div>
      `;

      const members = Array.isArray(crgr.memberUids) ? crgr.memberUids : [];
      renderMembers(members);

      // ===== Mural (MVP sem índice): carrega posts e filtra no cliente
      const postsSnap = await getDocs(collection(db, "posts"));
      const allPosts = postsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      // filtra: escopo all OU escopo crgrId
      const muralPosts = allPosts.filter(p => {
        const st = p.scope?.type;
        if(st === "all") return true;
        if(st === "crgr" && p.scope?.crgrId === crgrId) return true;
        return false;
      });

      // ordena client-side por createdAt
      muralPosts.sort((a,b) => {
        const at = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const bt = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return bt - at;
      });

      renderMural(muralPosts.slice(0, 60));
    }

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "index.html";
        return;
      }

      const profile = await ensureProfile(user);

      // gate permissão
      if(!canAccess(profile, "territorio")){
        window.location.href = "home.html";
        return;
      }

      const name = profile.name || user.displayName || (user.email ? user.email.split("@")[0] : "Usuário");
      userNameEl.textContent = name;
      userRoleEl.textContent = `Perfil: ${safeStr(profile.role || "comunidade")}`;
      userEmailEl.textContent = user.email || "—";
      setAvatar(user.photoURL || profile.photoURL || null, initialsFrom(name));

      if(isAdmin(profile)) adminLink.style.display = "flex";

      try{
        await loadCrgrAndMural(profile);
      }catch(err){
        console.error(err);
        crgrBox.textContent = "Erro ao carregar CRGR. Verifique permissões/rules.";
        muralEmpty.textContent = "Erro ao carregar mural.";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
